<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/purple/pace-theme-loading-bar.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.52dzd.com","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":true,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":true,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":null,"activeClass":"disqus"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Abp vNext 学习第七弹 - 作者参考上一篇 ：Abp vNext 学习(6). 领域层简介在前面的章节中, 我们使用 ABP 框架轻松地构建了一些服务;  使用 CrudAppService 基类, 而不是为标准的增删改查操作手工开发应用服务. 使用 generic repositories 自动完成数据层功能.  对于 “作者” 部分;  我们将要展示在需要的情况下, 如何 手工做一些事">
<meta property="og:type" content="article">
<meta property="og:title" content="Abp vNext 学习(7)">
<meta property="og:url" content="https://www.52dzd.com/abplearn/seventh/index.html">
<meta property="og:site_name" content="心雨纷扬的博客">
<meta property="og:description" content="Abp vNext 学习第七弹 - 作者参考上一篇 ：Abp vNext 学习(6). 领域层简介在前面的章节中, 我们使用 ABP 框架轻松地构建了一些服务;  使用 CrudAppService 基类, 而不是为标准的增删改查操作手工开发应用服务. 使用 generic repositories 自动完成数据层功能.  对于 “作者” 部分;  我们将要展示在需要的情况下, 如何 手工做一些事">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-12-26T08:52:43.000Z">
<meta property="article:modified_time" content="2023-05-31T23:32:09.000Z">
<meta property="article:author" content="Xyfy">
<meta property="article:tag" content="Abp vNext">
<meta property="article:tag" content="DDD">
<meta property="article:tag" content="BookStore">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.52dzd.com/abplearn/seventh/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.52dzd.com/abplearn/seventh/","path":"abplearn/seventh/","title":"Abp vNext 学习(7)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Abp vNext 学习(7) | 心雨纷扬的博客</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-JSVQ39TS9E"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-JSVQ39TS9E","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>







<script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5923374708970560" crossorigin="anonymous"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">心雨纷扬的博客</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一个简单的博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Abp-vNext-%E5%AD%A6%E4%B9%A0%E7%AC%AC%E4%B8%83%E5%BC%B9-%E4%BD%9C%E8%80%85"><span class="nav-number">1.</span> <span class="nav-text">Abp vNext 学习第七弹 - 作者</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%86%E5%9F%9F%E5%B1%82"><span class="nav-number">1.1.</span> <span class="nav-text">领域层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E8%80%85%E5%AE%9E%E4%BD%93"><span class="nav-number">1.1.2.</span> <span class="nav-text">作者实体</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AuthorManager-%E9%A2%86%E5%9F%9F%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.1.3.</span> <span class="nav-text">AuthorManager: 领域服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IAuthorRepository"><span class="nav-number">1.1.4.</span> <span class="nav-text">IAuthorRepository</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E6%88%90"><span class="nav-number">1.2.</span> <span class="nav-text">数据库集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#DBContext"><span class="nav-number">1.2.1.</span> <span class="nav-text">DBContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB"><span class="nav-number">1.2.2.</span> <span class="nav-text">创建数据库迁移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0-IAuthorRepository"><span class="nav-number">1.2.3.</span> <span class="nav-text">实现 IAuthorRepository</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="nav-number">1.3.</span> <span class="nav-text">应用服务层</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IAuthorAppService"><span class="nav-number">1.3.1.</span> <span class="nav-text">IAuthorAppService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AuthorDto"><span class="nav-number">1.3.1.1.</span> <span class="nav-text">AuthorDto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GetAuthorListDto"><span class="nav-number">1.3.1.2.</span> <span class="nav-text">GetAuthorListDto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateAuthorDto"><span class="nav-number">1.3.1.3.</span> <span class="nav-text">CreateAuthorDto</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UpdateAuthorDto"><span class="nav-number">1.3.1.4.</span> <span class="nav-text">UpdateAuthorDto</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AuthorAppService"><span class="nav-number">1.3.2.</span> <span class="nav-text">AuthorAppService</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GetAsync"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">GetAsync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GetListAsync"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">GetListAsync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateAsync"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">CreateAsync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UpdateAsync"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">UpdateAsync</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DeleteAsync"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">DeleteAsync</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E5%AE%9A%E4%B9%89"><span class="nav-number">1.3.3.</span> <span class="nav-text">权限定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%B0%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84"><span class="nav-number">1.3.4.</span> <span class="nav-text">对象到对象映射</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%A7%8D%E5%AD%90"><span class="nav-number">1.3.5.</span> <span class="nav-text">数据种子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E4%BD%9C%E8%80%85%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1"><span class="nav-number">1.3.6.</span> <span class="nav-text">测试作者应用服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI%EF%BC%9A%E7%94%A8%E6%88%B7%E7%95%8C%E9%9D%A2"><span class="nav-number">1.4.</span> <span class="nav-text">UI：用户界面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%9C%E8%80%85%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2"><span class="nav-number">1.4.1.</span> <span class="nav-text">作者列表页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Index-cshtml"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">Index.cshtml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IndexModel-cshtml-cs"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">IndexModel.cshtml.cs</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Index-js"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">Index.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%AC%E5%9C%B0%E5%8C%96"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">本地化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E5%85%A5%E4%B8%BB%E8%8F%9C%E5%8D%95"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">加入主菜单</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">运行应用程序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%BB%BA%E6%A8%A1%E6%80%81%E7%AA%97%E5%8F%A3"><span class="nav-number">1.4.2.</span> <span class="nav-text">新建模态窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateModal-cshtml"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">CreateModal.cshtml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateModal-cshtml-cs"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">CreateModal.cshtml.cs</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%BE%91%E6%A8%A1%E6%80%81%E7%AA%97%E5%8F%A3"><span class="nav-number">1.4.3.</span> <span class="nav-text">编辑模态窗口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#EditModal-cshtml"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">EditModal.cshtml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EditModal-cshtml-cs"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">EditModal.cshtml.cs</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%9C%E8%80%85%E4%B8%8E%E5%9B%BE%E4%B9%A6%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">1.5.</span> <span class="nav-text">作者与图书的关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%A8%E5%9B%BE%E4%B9%A6%E5%AE%9E%E4%BD%93%E4%B8%AD%E5%8A%A0%E5%85%A5%E5%85%B3%E7%B3%BB"><span class="nav-number">1.5.1.</span> <span class="nav-text">在图书实体中加入关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93-%E6%95%B0%E6%8D%AE%E8%BF%81%E7%A7%BB"><span class="nav-number">1.5.2.</span> <span class="nav-text">数据库 &amp; 数据迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0-EF-Core-%E6%98%A0%E5%B0%84"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">更新 EF Core 映射</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-EF-Core-%E8%BF%81%E7%A7%BB"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">新增 EF Core 迁移</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E7%A7%8D%E5%AD%90"><span class="nav-number">1.5.3.</span> <span class="nav-text">修改数据种子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E5%B1%82"><span class="nav-number">1.5.4.</span> <span class="nav-text">应用层</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E5%AF%B9%E8%B1%A1"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">数据传输对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BookDto"><span class="nav-number">1.5.4.1.1.</span> <span class="nav-text">BookDto</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CreateUpdateBookDto"><span class="nav-number">1.5.4.1.2.</span> <span class="nav-text">CreateUpdateBookDto</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AuthorLookupDto"><span class="nav-number">1.5.4.1.3.</span> <span class="nav-text">AuthorLookupDto</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IBookAppService"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">IBookAppService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BookAppService"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">BookAppService</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%B0%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84%E6%98%A0%E5%B0%84"><span class="nav-number">1.5.4.4.</span> <span class="nav-text">对象到对象映射映射</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="nav-number">1.5.5.</span> <span class="nav-text">单元测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E9%A1%B5%E9%9D%A2"><span class="nav-number">1.5.6.</span> <span class="nav-text">用户页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%BE%E4%B9%A6%E5%88%97%E8%A1%A8"><span class="nav-number">1.5.6.1.</span> <span class="nav-text">图书列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CreateModal"><span class="nav-number">1.5.6.2.</span> <span class="nav-text">CreateModal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#EditModal"><span class="nav-number">1.5.6.3.</span> <span class="nav-text">EditModal</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%88%B0%E5%AF%B9%E8%B1%A1%E6%98%A0%E5%B0%84%E9%85%8D%E7%BD%AE"><span class="nav-number">1.5.6.4.</span> <span class="nav-text">对象到对象映射配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo-Codes"><span class="nav-number">1.6.</span> <span class="nav-text">Demo Codes</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Xyfy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3h5Znk=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;xyfy"><i class="fab fa-github fa-fw"></i>GitHub</span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="bWFpbHRvOmJlbmd1YWhhb0BnbWFpbC5jb20=" title="E-Mail → mailto:benguahao@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</span>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.52dzd.com/abplearn/seventh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Xyfy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="心雨纷扬的博客">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Abp vNext 学习(7) | 心雨纷扬的博客">
      <meta itemprop="description" content>
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Abp vNext 学习(7)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-12-26 16:52:43" itemprop="dateCreated datePublished" datetime="2022-12-26T16:52:43+08:00">2022-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-06-01 07:32:09" itemprop="dateModified" datetime="2023-06-01T07:32:09+08:00">2023-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Abp/" itemprop="url" rel="index"><span itemprop="name">Abp</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/abplearn/seventh/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="abplearn/seventh/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Abp-vNext-学习第七弹-作者"><a href="#Abp-vNext-学习第七弹-作者" class="headerlink" title="Abp vNext 学习第七弹 - 作者"></a>Abp vNext 学习第七弹 - 作者</h1><p>参考上一篇 ：<a href="/abplearn/sixth/" title="Abp vNext 学习(6)">Abp vNext 学习(6)</a>.</p>
<h2 id="领域层"><a href="#领域层" class="headerlink" title="领域层"></a>领域层</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>在前面的章节中, 我们使用 ABP 框架轻松地构建了一些服务;</p>
<ul>
<li>使用 <code>CrudAppService</code> 基类, 而不是为标准的增删改查操作手工开发应用服务.</li>
<li>使用 <code>generic repositories</code> 自动完成数据层功能.</li>
</ul>
<p>对于 “作者” 部分;</p>
<ul>
<li>我们将要展示在需要的情况下, 如何 <em>手工做一些事情</em>.</li>
<li>我们将要实现一些 <em>领域驱动设计 (DDD) 最佳实践</em>.</li>
</ul>
<blockquote>
<p>开发将会逐层完成, 一次聚焦一层. 在真实项目中, 你会逐个功能(垂直)开发, 如同前面的教程. 通过这种方式, 你可以体验这两种方式</p>
</blockquote>
<span id="more"></span>

<h3 id="作者实体"><a href="#作者实体" class="headerlink" title="作者实体"></a>作者实体</h3><p>在 <code>.Domain</code> 项目中创建 <code>Authors</code> 文件夹 (命名空间), 在其中加入 <code>Author</code> 类:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> JetBrains.Annotations;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Entities.Auditing;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Author</span> : <span class="title">FullAuditedAggregateRoot</span>&lt;<span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">Author</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* This constructor is for deserialization / ORM purpose */</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="title">Author</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            Guid id,</span></span></span><br><span class="line"><span class="params"><span class="function">            [NotNull] <span class="built_in">string</span> name,</span></span></span><br><span class="line"><span class="params"><span class="function">            DateTime birthDate,</span></span></span><br><span class="line"><span class="params"><span class="function">            [CanBeNull] <span class="built_in">string</span> shortBio = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetName(name);</span><br><span class="line">            BirthDate = birthDate;</span><br><span class="line">            ShortBio = shortBio;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> Author <span class="title">ChangeName</span>(<span class="params">[NotNull] <span class="built_in">string</span> name</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            SetName(name);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SetName</span>(<span class="params">[NotNull] <span class="built_in">string</span> name</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Name = Check.NotNullOrWhiteSpace(</span><br><span class="line">                name,</span><br><span class="line">                <span class="keyword">nameof</span>(name),</span><br><span class="line">                maxLength: AuthorConsts.MaxNameLength</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>由 <code>FullAuditedAggregateRoot&lt;Guid&gt;</code> 继承使得实体支持软删除 (指实体被删除时, 它并没有从数据库中被删除, 而只是被标记删除), 实体也具有了 审计 属性.</li>
<li><code>Name</code> 属性的 <code>private set</code> 限制从类的外部设置这个属性. 有两种方法设置名字 (两种都进行了验证):<ul>
<li>当新建一个作者时, 通过构造函数.</li>
<li>使用 <code>ChangeName</code> 方法更新名字.</li>
</ul>
</li>
<li>构造函数 和 <code>ChangeName</code> 方法的访问级别是 <code>internal</code>, 强制这些方法只能在领域层由 <code>AuthorManager</code> 使用. 稍后将对此进行解释.</li>
<li><code>Check</code> 类是一个ABP框架工具类, 用于检查方法参数 (如果参数非法会抛出 <code>ArgumentException</code>).</li>
</ul>
<p><code>AuthorConsts</code> 是一个简单的类, 它位于 <code>.Domain.Shared</code> 项目的 <code>Authors</code> 命名空间 (文件夹)中:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AuthorConsts</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">int</span> MaxNameLength = <span class="number">64</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>.Domain.Shared</code> 项目中创建这个类, 因为数据传输类 (DTOs) 稍后会再一次用到它.</p>
<h3 id="AuthorManager-领域服务"><a href="#AuthorManager-领域服务" class="headerlink" title="AuthorManager: 领域服务"></a>AuthorManager: 领域服务</h3><p><code>Author</code> 构造函数和 <code>ChangeName</code> 方法的访问级别是 <code>internal</code>, 所以它们只能在领域层使用. 在 <code>.BookStore.Domain</code> 项目中的 <code>Authors</code> 文件夹 (命名空间)创建 <code>AuthorManager</code> 类:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> JetBrains.Annotations;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorManager</span> : <span class="title">DomainService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorRepository _authorRepository;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AuthorManager</span>(<span class="params">IAuthorRepository authorRepository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorRepository = authorRepository;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Author&gt; <span class="title">CreateAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            [NotNull] <span class="built_in">string</span> name,</span></span></span><br><span class="line"><span class="params"><span class="function">            DateTime birthDate,</span></span></span><br><span class="line"><span class="params"><span class="function">            [CanBeNull] <span class="built_in">string</span> shortBio = <span class="literal">null</span></span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Check.NotNullOrWhiteSpace(name, <span class="keyword">nameof</span>(name));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> existingAuthor = <span class="keyword">await</span> _authorRepository.FindByNameAsync(name);</span><br><span class="line">            <span class="keyword">if</span> (existingAuthor != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorAlreadyExistsException(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Author(</span><br><span class="line">                GuidGenerator.Create(),</span><br><span class="line">                name,</span><br><span class="line">                birthDate,</span><br><span class="line">                shortBio</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">ChangeNameAsync</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            [NotNull] Author author,</span></span></span><br><span class="line"><span class="params"><span class="function">            [NotNull] <span class="built_in">string</span> newName</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            Check.NotNull(author, <span class="keyword">nameof</span>(author));</span><br><span class="line">            Check.NotNullOrWhiteSpace(newName, <span class="keyword">nameof</span>(newName));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> existingAuthor = <span class="keyword">await</span> _authorRepository.FindByNameAsync(newName);</span><br><span class="line">            <span class="keyword">if</span> (existingAuthor != <span class="literal">null</span> &amp;&amp; existingAuthor.Id != author.Id)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AuthorAlreadyExistsException(newName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            author.ChangeName(newName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AuthorManager</code> 强制使用一种可控的方式创建作者和修改作者的名字. 应用层 (后面会介绍) 将会使用这些方法.</li>
</ul>
<blockquote>
<p>DDD 提示: 如非必须并且用于执行核心业务规则, 不要引入领域服务方法. 对于这个场景, 我们使用这个服务保证名字的唯一性.</p>
</blockquote>
<p>两个方法都检查是否存在同名用户, 如果存在, 抛出业务异常 <code>AuthorAlreadyExistsException</code>, 这个异常定义在 <code>.Domain</code> 项目 (<code>Authors</code> 文件夹中):</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Volo.Abp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorAlreadyExistsException</span> : <span class="title">BusinessException</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AuthorAlreadyExistsException</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">BookStoreDomainErrorCodes.AuthorAlreadyExists</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            WithData(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>BusinessException</code> 是一个特殊的异常类型. 在需要时抛出领域相关异常是一个好的实践. ABP框架会自动处理它, 并且它也容易本地化. <code>WithData(...)</code> 方法提供额外的数据给异常对象, 这些数据将会在本地化中或出于其它一些目的被使用.</p>
<p>打开 <code>.Domain.Shared</code> 项目中的 <code>BookStoreDomainErrorCodes</code> 并修改为:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BookStoreDomainErrorCodes</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> AuthorAlreadyExists = <span class="string">&quot;BookStore:00001&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里定义了一个字符串, 表示应用程序抛出的错误码, 这个错误码可以被客户端应用程序处理. 为了用户, 你可能希望本地化它. 打开 <code>.Domain.Shared</code> 项目中的 <code>Localization/BookStore/en.json</code> , 加入以下项:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;BookStore:00001&quot;</span><span class="punctuation">:</span> <span class="string">&quot;There is already an author with the same name: &#123;name&#125;&quot;</span></span><br></pre></td></tr></table></figure>

<p>当 AuthorAlreadyExistsException 被抛出, 终端用户将会在UI上看到组织好的错误消息.</p>
<h3 id="IAuthorRepository"><a href="#IAuthorRepository" class="headerlink" title="IAuthorRepository"></a>IAuthorRepository</h3><p><code>AuthorManager</code> 注入了 <code>IAuthorRepository</code>, 所以我们需要定义它. 在 <code>.Domain</code> 项目的 <code>Authors</code> 文件夹 (命名空间) 中创建这个新接口:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IAuthorRepository</span> : <span class="title">IRepository</span>&lt;<span class="title">Author</span>, <span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Task&lt;Author&gt; <span class="title">FindByNameAsync</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Task&lt;List&lt;Author&gt;&gt; GetListAsync(</span><br><span class="line">            <span class="built_in">int</span> skipCount,</span><br><span class="line">            <span class="built_in">int</span> maxResultCount,</span><br><span class="line">            <span class="built_in">string</span> sorting,</span><br><span class="line">            <span class="built_in">string</span> filter = <span class="literal">null</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>IAuthorRepository</code> 扩展了标准 <code>IRepository&lt;Author, Guid&gt;</code> 接口, 所以所有的标准 <code>repository</code> 方法对于 <code>IAuthorRepository</code> 都是可用的.</li>
<li><code>FindByNameAsync</code> 在 <code>AuthorManager</code> 中用来根据姓名查询用户.</li>
<li><code>GetListAsync</code> 用于应用层以获得一个排序的, 经过过滤的作者列表, 显示在UI上.</li>
</ul>
<h2 id="数据库集成"><a href="#数据库集成" class="headerlink" title="数据库集成"></a>数据库集成</h2><h3 id="DBContext"><a href="#DBContext" class="headerlink" title="DBContext"></a>DBContext</h3><p>打开 Acme.BookStore.EntityFrameworkCore 项目中的 BookStoreDbContext 加入 DbSet 属性:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> DbSet&lt;Author&gt; Authors &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>定位到相同项目中的 <code>BookStoreDbContext</code> 类中的 <code>OnModelCreating</code> 方法, 加入以下代码到方法的结尾:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">builder.Entity&lt;Author&gt;(b =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    b.ToTable(BookStoreConsts.DbTablePrefix + <span class="string">&quot;Authors&quot;</span>,</span><br><span class="line">        BookStoreConsts.DbSchema);</span><br><span class="line"></span><br><span class="line">    b.ConfigureByConvention();</span><br><span class="line"></span><br><span class="line">    b.Property(x =&gt; x.Name)</span><br><span class="line">        .IsRequired()</span><br><span class="line">        .HasMaxLength(AuthorConsts.MaxNameLength);</span><br><span class="line"></span><br><span class="line">    b.HasIndex(x =&gt; x.Name);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这和前面的 <code>Book</code> 实体做的一样, 所以不再细说.</p>
<h3 id="创建数据库迁移"><a href="#创建数据库迁移" class="headerlink" title="创建数据库迁移"></a>创建数据库迁移</h3><p>配置启动解决方案为使用 <code>Entity Framework Core Code First Migrations</code>. 因为我们还没有修改数据库映射配置，所以需要创建一个新的迁移并对数据库应用变更.</p>
<p>打开命令行终端, 切换当前目录为 <code>.EntityFrameworkCore</code> 项目目录, 输入以下命令:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add Added_Authors</span><br></pre></td></tr></table></figure>

<p>你可以在同一个命令行终端中使用以下命令对数据库应用更改:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database update</span><br></pre></td></tr></table></figure>

<h3 id="实现-IAuthorRepository"><a href="#实现-IAuthorRepository" class="headerlink" title="实现 IAuthorRepository"></a>实现 IAuthorRepository</h3><p>在 <code>.EntityFrameworkCore</code> 项目 (<code>Authors</code> 文件夹)中创建一个新类 <code>EfCoreAuthorRepository</code>, 粘贴以下代码:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Dynamic.Core;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories.EntityFrameworkCore;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EfCoreAuthorRepository</span></span><br><span class="line">        : <span class="title">EfCoreRepository</span>&lt;<span class="title">BookStoreDbContext</span>, <span class="title">Author</span>, <span class="title">Guid</span>&gt;,</span><br><span class="line">            <span class="title">IAuthorRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EfCoreAuthorRepository</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IDbContextProvider&lt;BookStoreDbContext&gt; dbContextProvider</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">dbContextProvider</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;Author&gt; <span class="title">FindByNameAsync</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> dbSet = <span class="keyword">await</span> GetDbSetAsync();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> dbSet.FirstOrDefaultAsync(author =&gt; author.Name == name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;List&lt;Author&gt;&gt; GetListAsync(</span><br><span class="line">            <span class="built_in">int</span> skipCount,</span><br><span class="line">            <span class="built_in">int</span> maxResultCount,</span><br><span class="line">            <span class="built_in">string</span> sorting,</span><br><span class="line">            <span class="built_in">string</span> filter = <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> dbSet = <span class="keyword">await</span> GetDbSetAsync();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> dbSet</span><br><span class="line">                .WhereIf(</span><br><span class="line">                    !filter.IsNullOrWhiteSpace(),</span><br><span class="line">                    author =&gt; author.Name.Contains(filter)</span><br><span class="line">                 )</span><br><span class="line">                .OrderBy(sorting)</span><br><span class="line">                .Skip(skipCount)</span><br><span class="line">                .Take(maxResultCount)</span><br><span class="line">                .ToListAsync();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继承自 <code>EfCoreRepository</code>, 所以继承了标准<code>repository</code>的方法实现.</li>
<li><code>WhereIf</code> 是ABP 框架的快捷扩展方法. 它仅当第一个条件满足时, 执行 <code>Where</code> 查询. (根据名字查询, 仅当 <code>filter</code> 不为空). 你可以不使用这个方法, 但这些快捷方法可以提高效率.</li>
<li><code>sorting</code> 可以是一个字符串, 如 <code>Name</code>, <code>Name ASC</code> 或 <code>Name DESC</code>. 通过使用 <code>System.Linq.Dynamic.Core</code> NuGet 包来得到支持.</li>
</ul>
<h2 id="应用服务层"><a href="#应用服务层" class="headerlink" title="应用服务层"></a>应用服务层</h2><h3 id="IAuthorAppService"><a href="#IAuthorAppService" class="headerlink" title="IAuthorAppService"></a>IAuthorAppService</h3><p>我们首先创建 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvQXBwbGljYXRpb24tU2VydmljZXM=">应用服务<i class="fa fa-external-link-alt"></i></span> 接口和相关的 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvRGF0YS1UcmFuc2Zlci1PYmplY3Rz">DTO<i class="fa fa-external-link-alt"></i></span>s. 在 <code>Acme.BookStore.Application.Contracts</code> 项目的 <code>Authors</code> 命名空间 (文件夹) 创建一个新接口 <code>IAuthorAppService</code>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IAuthorAppService</span> : <span class="title">IApplicationService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Task&lt;AuthorDto&gt; <span class="title">GetAsync</span>(<span class="params">Guid id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        Task&lt;PagedResultDto&lt;AuthorDto&gt;&gt; GetListAsync(GetAuthorListDto input);</span><br><span class="line"></span><br><span class="line">        <span class="function">Task&lt;AuthorDto&gt; <span class="title">CreateAsync</span>(<span class="params">CreateAuthorDto input</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">Task <span class="title">UpdateAsync</span>(<span class="params">Guid id, UpdateAuthorDto input</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">Task <span class="title">DeleteAsync</span>(<span class="params">Guid id</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>IApplicationService</code> 是一个常规接口, 所有应用服务都继承自它, 所以 ABP 框架可以识别它们.</li>
<li>在 <code>Author</code> 实体中定义标准方法用于CRUD操作.</li>
<li><code>PagedResultDto</code> 是一个ABP框架中预定义的 DTO 类. 它拥有一个 <code>Items</code> 集合 和一个 <code>TotalCount</code> 属性, 用于返回分页结果.</li>
<li>优先从 <code>CreateAsync</code> 方法返回 <code>AuthorDto</code> (新创建的作者), 虽然在这个程序中没有这么做 - 这里只是展示一种不同用法.</li>
</ul>
<p>这个类使用下面定义的DTOs (为你的项目创建它们).</p>
<h4 id="AuthorDto"><a href="#AuthorDto" class="headerlink" title="AuthorDto"></a>AuthorDto</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorDto</span> : <span class="title">EntityDto</span>&lt;<span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>EntityDto&lt;T&gt;</code> 只有一个类型为指定泛型参数的 <code>Id</code> 属性. 你可以自己创建 <code>Id</code> 属性, 而不是继承自 <code>EntityDto&lt;T&gt;</code>.</li>
</ul>
<h4 id="GetAuthorListDto"><a href="#GetAuthorListDto" class="headerlink" title="GetAuthorListDto"></a>GetAuthorListDto</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GetAuthorListDto</span> : <span class="title">PagedAndSortedResultRequestDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span>? Filter &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Filter</code> 用于搜索作者. 它可以是 <code>null</code> (或空字符串) 以获得所有用户.</li>
<li><code>PagedAndSortedResultRequestDto</code> 具有标准分页和排序属性: <code>int MaxResultCount</code>, <code>int SkipCount</code> 和 <code>string Sorting</code>.</li>
</ul>
<blockquote>
<p>ABP 框架拥有这些基本的DTO类以简化并标准化你的DTOs. 参阅 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvRGF0YS1UcmFuc2Zlci1PYmplY3Rz">DTO 文档<i class="fa fa-external-link-alt"></i></span> 获得所有DTO类的详细信息.</p>
</blockquote>
<h4 id="CreateAuthorDto"><a href="#CreateAuthorDto" class="headerlink" title="CreateAuthorDto"></a>CreateAuthorDto</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateAuthorDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">StringLength(AuthorConsts.MaxNameLength)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据标记特性可以用来验证DTO. 参阅 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvVmFsaWRhdGlvbg==">验证文档<i class="fa fa-external-link-alt"></i></span> 获得详细信息.</p>
<h4 id="UpdateAuthorDto"><a href="#UpdateAuthorDto" class="headerlink" title="UpdateAuthorDto"></a>UpdateAuthorDto</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UpdateAuthorDto</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        [<span class="meta">StringLength(AuthorConsts.MaxNameLength)</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Required</span>]</span><br><span class="line">        <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们可以在创建和更新操作间分享 (重用) 相同的DTO. 虽然可以这么做, 但我们推荐为这些操作创建不同的DTOs, 因为我们发现随着时间的推移, 它们通常会变得有差异. 所以, 与紧耦合相比, 代码重复也是合理的.</p>
</blockquote>
<h3 id="AuthorAppService"><a href="#AuthorAppService" class="headerlink" title="AuthorAppService"></a>AuthorAppService</h3><p>是时候实现 <code>IAuthorAppService</code> 接口了. 在 <code>Acme.BookStore.Application</code> 项目的 <code>Authors</code> 命名空间 (文件夹) 中创建一个新类 <code>AuthorAppService</code> :</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Permissions;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Authorize(BookStorePermissions.Authors.Default)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorAppService</span> : <span class="title">BookStoreAppService</span>, <span class="title">IAuthorAppService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorRepository _authorRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> AuthorManager _authorManager;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AuthorAppService</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IAuthorRepository authorRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">            AuthorManager authorManager</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorRepository = authorRepository;</span><br><span class="line">            _authorManager = authorManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//...SERVICE METHODS WILL COME HERE...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>[Authorize(BookStorePermissions.Authors.Default)]</code> 是一个检查权限(策略)的声明式方法, 用来给当前用户授权. 参阅 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvQXV0aG9yaXphdGlvbg==">授权文档<i class="fa fa-external-link-alt"></i></span> 获得详细信息. <code>BookStorePermissions</code> 类在后文会被更新, 现在不需要担心编译错误.</li>
<li>由 <code>BookStoreAppService</code> 派生, 这个类是一个简单基类, 可以做为模板. 它继承自标准的 <code>ApplicationService</code> 类.</li>
<li>实现上面定义的 <code>IAuthorAppService</code> .</li>
<li>注入 <code>IAuthorRepository</code> 和 <code>AuthorManager</code> 以使用服务方法.</li>
</ul>
<p>现在, 我们逐个介绍服务方法. 复制这些方法到 <code>AuthorAppService</code> 类.</p>
<h4 id="GetAsync"><a href="#GetAsync" class="headerlink" title="GetAsync"></a>GetAsync</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;AuthorDto&gt; <span class="title">GetAsync</span>(<span class="params">Guid id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> author = <span class="keyword">await</span> _authorRepository.GetAsync(id);</span><br><span class="line">    <span class="keyword">return</span> ObjectMapper.Map&lt;Author, AuthorDto&gt;(author);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法根据 <code>Id</code> 获得 <code>Author</code> 实体, 使用 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvT2JqZWN0LVRvLU9iamVjdC1NYXBwaW5n">对象到对象映射<i class="fa fa-external-link-alt"></i></span> 转换为 <code>AuthorDto</code>. 这需要配置AutoMapper, 后面会介绍.</p>
<h4 id="GetListAsync"><a href="#GetListAsync" class="headerlink" title="GetListAsync"></a>GetListAsync</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;PagedResultDto&lt;AuthorDto&gt;&gt; GetListAsync(GetAuthorListDto input)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (input.Sorting.IsNullOrWhiteSpace())</span><br><span class="line">    &#123;</span><br><span class="line">        input.Sorting = <span class="keyword">nameof</span>(Author.Name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> authors = <span class="keyword">await</span> _authorRepository.GetListAsync(</span><br><span class="line">        input.SkipCount,</span><br><span class="line">        input.MaxResultCount,</span><br><span class="line">        input.Sorting,</span><br><span class="line">        input.Filter</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> totalCount = input.Filter == <span class="literal">null</span></span><br><span class="line">        ? <span class="keyword">await</span> _authorRepository.CountAsync()</span><br><span class="line">        : <span class="keyword">await</span> _authorRepository.CountAsync(</span><br><span class="line">            author =&gt; author.Name.Contains(input.Filter));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PagedResultDto&lt;AuthorDto&gt;(</span><br><span class="line">        totalCount,</span><br><span class="line">        ObjectMapper.Map&lt;List&lt;Author&gt;, List&lt;AuthorDto&gt;&gt;(authors)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为处理客户端没有设置的情况, 在方法的开头设置默认排序是 “根据作者名”.</li>
<li>使用 <code>IAuthorRepository.GetListAsync</code> 从数据库中获得分页的, 排序的和过滤的作者列表. 我们已经在教程的前一章中实现了它. 再一次强调, 实际上不需要创建这个方法, 因为我们可以从数据库中直接查询, 这里只是演示如何创建自定义repository方法.</li>
<li>直接查询 <code>AuthorRepository</code> , 得到作者的数量. 如果客户端发送了过滤条件, 会得到过滤后的作者数量.</li>
<li>最后, 通过映射 <code>Author</code> 列表到 <code>AuthorDto</code> 列表, 返回分页后的结果.</li>
</ul>
<h4 id="CreateAsync"><a href="#CreateAsync" class="headerlink" title="CreateAsync"></a>CreateAsync</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(BookStorePermissions.Authors.Create)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;AuthorDto&gt; <span class="title">CreateAsync</span>(<span class="params">CreateAuthorDto input</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> author = <span class="keyword">await</span> _authorManager.CreateAsync(</span><br><span class="line">        input.Name,</span><br><span class="line">        input.BirthDate,</span><br><span class="line">        input.ShortBio</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _authorRepository.InsertAsync(author);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ObjectMapper.Map&lt;Author, AuthorDto&gt;(author);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CreateAsync</code> 需要 <code>BookStorePermissions.Authors.Create</code> 权限 (另外包括 <code>AuthorAppService</code> 类声明的 <code>BookStorePermissions.Authors.Default</code> 权限).</li>
<li>使用 <code>AuthorManager</code> (领域服务) 创建新作者.</li>
<li>使用 <code>IAuthorRepository.InsertAsync</code> 插入新作者到数据库.</li>
<li>使用 <code>ObjectMapper</code> 返回 <code>AuthorDto</code> , 代表新创建的作者.</li>
</ul>
<blockquote>
<p><strong>DDD提示</strong>: 一些开发者可能会发现可以在 <code>_authorManager.CreateAsync</code> 插入新实体. 我们认为把它留给应用层是更好的设计, 因为应用层更了解应该何时插入实体到数据库(在插入实体前可能需要额外的工作. 如果在领域层插入, 可能需要额外的更新操作). 但是, 你拥有最终的决定权.</p>
</blockquote>
<h4 id="UpdateAsync"><a href="#UpdateAsync" class="headerlink" title="UpdateAsync"></a>UpdateAsync</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(BookStorePermissions.Authors.Edit)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">UpdateAsync</span>(<span class="params">Guid id, UpdateAuthorDto input</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> author = <span class="keyword">await</span> _authorRepository.GetAsync(id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (author.Name != input.Name)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">await</span> _authorManager.ChangeNameAsync(author, input.Name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    author.BirthDate = input.BirthDate;</span><br><span class="line">    author.ShortBio = input.ShortBio;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> _authorRepository.UpdateAsync(author);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>UpdateAsync</code> 需要额外的 <code>BookStorePermissions.Authors.Edit</code> 权限.</li>
<li>使用 <code>IAuthorRepository.GetAsync</code> 从数据库中获得作者实体. 如果给定的id没有找到作者, <code>GetAsync</code> 抛出 <code>EntityNotFoundException</code>, 这在web应用程序中导致一个 <code>404</code> HTTP 状态码. 在更新操作中先获取实体再更新它, 是一个好的实践.</li>
<li>如果客户端请求, 使用 <code>AuthorManager.ChangeNameAsync</code> (领域服务方法) 修改作者姓名.</li>
<li>因为没有任何业务逻辑, 直接更新 <code>BirthDate</code> 和 <code>ShortBio</code>, 它们可以接受任何值.</li>
<li>最后, 调用 <code>IAuthorRepository.UpdateAsync</code> 更新实体到数据库.</li>
</ul>
<blockquote>
<p><strong>EF Core 提示</strong>: Entity Framework Core 拥有 <strong>change tracking</strong> 系统并在unit of work 结束时 <strong>自动保存</strong> 任何修改到实体 (你可以简单地认为APB框架在方法结束时自动调用 <code>SaveChanges</code>). 所以, 即使你在方法结束时没有调用 <code>_authorRepository.UpdateAsync(...)</code> , 它依然可以工作. 如果你不考虑以后修改EF Core, 你可以移除这一行.</p>
</blockquote>
<h4 id="DeleteAsync"><a href="#DeleteAsync" class="headerlink" title="DeleteAsync"></a>DeleteAsync</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Authorize(BookStorePermissions.Authors.Delete)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">DeleteAsync</span>(<span class="params">Guid id</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">await</span> _authorRepository.DeleteAsync(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>DeleteAsync</code> 需要额外的 <code>BookStorePermissions.Authors.Delete</code> 权限.</li>
<li>直接使用repository的 <code>DeleteAsync</code> 方法.</li>
</ul>
<h3 id="权限定义"><a href="#权限定义" class="headerlink" title="权限定义"></a>权限定义</h3><p>你还不能编译代码, 因为它需要 <code>BookStorePermissions</code> 类定义中一些常数.</p>
<p>打开 <code>Acme.BookStore.Application.Contracts</code> 项目中的 <code>BookStorePermissions</code> 类 (在 <code>Permissions</code> 文件夹中), 修改为如下代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Permissions</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">BookStorePermissions</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> GroupName = <span class="string">&quot;BookStore&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Books</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Default = GroupName + <span class="string">&quot;.Books&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Create = Default + <span class="string">&quot;.Create&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Edit = Default + <span class="string">&quot;.Edit&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Delete = Default + <span class="string">&quot;.Delete&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// *** ADDED a NEW NESTED CLASS ***</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Authors</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Default = GroupName + <span class="string">&quot;.Authors&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Create = Default + <span class="string">&quot;.Create&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Edit = Default + <span class="string">&quot;.Edit&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">const</span> <span class="built_in">string</span> Delete = Default + <span class="string">&quot;.Delete&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后打开同一项目中的 <code>BookStorePermissionDefinitionProvider</code>, 在 <code>Define</code> 方法的结尾加入以下行:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> authorsPermission = bookStoreGroup.AddPermission(</span><br><span class="line">    BookStorePermissions.Authors.Default, L(<span class="string">&quot;Permission:Authors&quot;</span>));</span><br><span class="line"></span><br><span class="line">authorsPermission.AddChild(</span><br><span class="line">    BookStorePermissions.Authors.Create, L(<span class="string">&quot;Permission:Authors.Create&quot;</span>));</span><br><span class="line"></span><br><span class="line">authorsPermission.AddChild(</span><br><span class="line">    BookStorePermissions.Authors.Edit, L(<span class="string">&quot;Permission:Authors.Edit&quot;</span>));</span><br><span class="line"></span><br><span class="line">authorsPermission.AddChild(</span><br><span class="line">    BookStorePermissions.Authors.Delete, L(<span class="string">&quot;Permission:Authors.Delete&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>最后, 在 <code>Acme.BookStore.Domain.Shared</code> 项目中的 <code>Localization/BookStore/en.json</code> 加入以下项, 用以本地化权限名称:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Permission:Authors&quot;</span>: <span class="string">&quot;Author Management&quot;</span>,</span><br><span class="line"><span class="string">&quot;Permission:Authors.Create&quot;</span>: <span class="string">&quot;Creating new authors&quot;</span>,</span><br><span class="line"><span class="string">&quot;Permission:Authors.Edit&quot;</span>: <span class="string">&quot;Editing the authors&quot;</span>,</span><br><span class="line"><span class="string">&quot;Permission:Authors.Delete&quot;</span>: <span class="string">&quot;Deleting the authors&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>简体中文翻译请打开<code>zh-Hans.json</code>文件 ,并将”Texts”对象中对应的值替换为中文.</p>
</blockquote>
<h3 id="对象到对象映射"><a href="#对象到对象映射" class="headerlink" title="对象到对象映射"></a>对象到对象映射</h3><p><code>AuthorAppService</code> 使用 <code>ObjectMapper</code> 将 <code>Author</code> 对象 转换为 <code>AuthorDto</code> 对象. 所以, 我们需要在 AutoMapper 配置中定义映射.</p>
<p>打开 <code>Acme.BookStore.Application</code> 项目中的 <code>BookStoreApplicationAutoMapperProfile</code> 类, 加入以下行到构造函数:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateMap&lt;Author, AuthorDto&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="数据种子"><a href="#数据种子" class="headerlink" title="数据种子"></a>数据种子</h3><p>如同图书管理部分所做的, 在数据库中生成一些初始作者实体. 不仅当第一次运行应用程序时是有用的, 对自动化测试也是很有用的.</p>
<p>打开 <code>Acme.BookStore.Domain</code> 项目中的 <code>BookStoreDataSeederContributor</code>, 修改文件内容如下:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Data;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookStoreDataSeederContributor</span></span><br><span class="line">        : <span class="title">IDataSeedContributor</span>, <span class="title">ITransientDependency</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRepository&lt;Book, Guid&gt; _bookRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorRepository _authorRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> AuthorManager _authorManager;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookStoreDataSeederContributor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IRepository&lt;Book, Guid&gt; bookRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">            IAuthorRepository authorRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">            AuthorManager authorManager</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _bookRepository = bookRepository;</span><br><span class="line">            _authorRepository = authorRepository;</span><br><span class="line">            _authorManager = authorManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SeedAsync</span>(<span class="params">DataSeedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _bookRepository.GetCountAsync() &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> _bookRepository.InsertAsync(</span><br><span class="line">                    <span class="keyword">new</span> Book</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;1984&quot;</span>,</span><br><span class="line">                        Type = BookType.Dystopia,</span><br><span class="line">                        PublishDate = <span class="keyword">new</span> DateTime(<span class="number">1949</span>, <span class="number">6</span>, <span class="number">8</span>),</span><br><span class="line">                        Price = <span class="number">19.84f</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    autoSave: <span class="literal">true</span></span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">await</span> _bookRepository.InsertAsync(</span><br><span class="line">                    <span class="keyword">new</span> Book</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;The Hitchhiker&#x27;s Guide to the Galaxy&quot;</span>,</span><br><span class="line">                        Type = BookType.ScienceFiction,</span><br><span class="line">                        PublishDate = <span class="keyword">new</span> DateTime(<span class="number">1995</span>, <span class="number">9</span>, <span class="number">27</span>),</span><br><span class="line">                        Price = <span class="number">42.0f</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    autoSave: <span class="literal">true</span></span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ADDED SEED DATA FOR AUTHORS</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _authorRepository.GetCountAsync() &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> _authorRepository.InsertAsync(</span><br><span class="line">                    <span class="keyword">await</span> _authorManager.CreateAsync(</span><br><span class="line">                        <span class="string">&quot;George Orwell&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> DateTime(<span class="number">1903</span>, <span class="number">06</span>, <span class="number">25</span>),</span><br><span class="line">                        <span class="string">&quot;Orwell produced literary criticism and poetry, fiction and polemical journalism; and is best known for the allegorical novella Animal Farm (1945) and the dystopian novel Nineteen Eighty-Four (1949).&quot;</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">await</span> _authorRepository.InsertAsync(</span><br><span class="line">                    <span class="keyword">await</span> _authorManager.CreateAsync(</span><br><span class="line">                        <span class="string">&quot;Douglas Adams&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> DateTime(<span class="number">1952</span>, <span class="number">03</span>, <span class="number">11</span>),</span><br><span class="line">                        <span class="string">&quot;Douglas Adams was an English author, screenwriter, essayist, humorist, satirist and dramatist. Adams was an advocate for environmentalism and conservation, a lover of fast cars, technological innovation and the Apple Macintosh, and a self-proclaimed &#x27;radical atheist&#x27;.&quot;</span></span><br><span class="line">                    )</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你现在可以运行 <code>.DbMigrator</code> 控制台应用程序, <strong>迁移</strong> <strong>数据库 schema</strong> 并生成 <strong>种子</strong> 初始数据.</p>
<h3 id="测试作者应用服务"><a href="#测试作者应用服务" class="headerlink" title="测试作者应用服务"></a>测试作者应用服务</h3><p>最后, 你可以为 <code>IAuthorAppService</code> 写一些测试. 在 <code>Acme.BookStore.Application.Tests</code> 项目的 <code>Authors</code> 命名空间(文件夹)中加入一个名为 <code>AuthorAppService_Tests</code> 新类:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Shouldly;</span><br><span class="line"><span class="keyword">using</span> Xunit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorAppService_Tests</span> : <span class="title">BookStoreApplicationTestBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorAppService _authorAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AuthorAppService_Tests</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorAppService = GetRequiredService&lt;IAuthorAppService&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Get_All_Authors_Without_Any_Filter</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> _authorAppService.GetListAsync(<span class="keyword">new</span> GetAuthorListDto());</span><br><span class="line"></span><br><span class="line">            result.TotalCount.ShouldBeGreaterThanOrEqualTo(<span class="number">2</span>);</span><br><span class="line">            result.Items.ShouldContain(author =&gt; author.Name == <span class="string">&quot;George Orwell&quot;</span>);</span><br><span class="line">            result.Items.ShouldContain(author =&gt; author.Name == <span class="string">&quot;Douglas Adams&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Get_Filtered_Authors</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> _authorAppService.GetListAsync(</span><br><span class="line">                <span class="keyword">new</span> GetAuthorListDto &#123;Filter = <span class="string">&quot;George&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">            result.TotalCount.ShouldBeGreaterThanOrEqualTo(<span class="number">1</span>);</span><br><span class="line">            result.Items.ShouldContain(author =&gt; author.Name == <span class="string">&quot;George Orwell&quot;</span>);</span><br><span class="line">            result.Items.ShouldNotContain(author =&gt; author.Name == <span class="string">&quot;Douglas Adams&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Create_A_New_Author</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> authorDto = <span class="keyword">await</span> _authorAppService.CreateAsync(</span><br><span class="line">                <span class="keyword">new</span> CreateAuthorDto</span><br><span class="line">                &#123;</span><br><span class="line">                    Name = <span class="string">&quot;Edward Bellamy&quot;</span>,</span><br><span class="line">                    BirthDate = <span class="keyword">new</span> DateTime(<span class="number">1850</span>, <span class="number">05</span>, <span class="number">22</span>),</span><br><span class="line">                    ShortBio = <span class="string">&quot;Edward Bellamy was an American author...&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            authorDto.Id.ShouldNotBe(Guid.Empty);</span><br><span class="line">            authorDto.Name.ShouldBe(<span class="string">&quot;Edward Bellamy&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Not_Allow_To_Create_Duplicate_Author</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> Assert.ThrowsAsync&lt;AuthorAlreadyExistsException&gt;(<span class="keyword">async</span> () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> _authorAppService.CreateAsync(</span><br><span class="line">                    <span class="keyword">new</span> CreateAuthorDto</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;Douglas Adams&quot;</span>,</span><br><span class="line">                        BirthDate = DateTime.Now,</span><br><span class="line">                        ShortBio = <span class="string">&quot;...&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span> Test other methods...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成应用服务方法的测试, 它们应该很容易理解.</p>
<h2 id="UI：用户界面"><a href="#UI：用户界面" class="headerlink" title="UI：用户界面"></a>UI：用户界面</h2><h3 id="作者列表页面"><a href="#作者列表页面" class="headerlink" title="作者列表页面"></a>作者列表页面</h3><p>在 <code>Acme.BookStore.Web</code> 项目的 <code>Pages/Authors</code> 文件夹下创建一个新的razor页面, <code>Index.cshtml</code>, 修改文件内容如下.</p>
<h4 id="Index-cshtml"><a href="#Index-cshtml" class="headerlink" title="Index.cshtml"></a>Index.cshtml</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@page</span><br><span class="line">@using Acme.BookStore.Localization</span><br><span class="line">@using Acme.BookStore.Permissions</span><br><span class="line">@using Acme.BookStore.Web.Pages.Authors</span><br><span class="line">@using Microsoft.AspNetCore.Authorization</span><br><span class="line">@using Microsoft.Extensions.Localization</span><br><span class="line">@inject IStringLocalizer<span class="tag">&lt;<span class="name">BookStoreResource</span>&gt;</span> L</span><br><span class="line">@inject IAuthorizationService AuthorizationService</span><br><span class="line">@model IndexModel</span><br><span class="line"></span><br><span class="line">@section scripts</span><br><span class="line">&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-script</span> <span class="attr">src</span>=<span class="string">&quot;/Pages/Authors/Index.js&quot;</span>/&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">abp-card</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-card-header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-row</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-column</span> <span class="attr">size-md</span>=<span class="string">&quot;_6&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">abp-card-title</span>&gt;</span>@L[&quot;Authors&quot;]<span class="tag">&lt;/<span class="name">abp-card-title</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">abp-column</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-column</span> <span class="attr">size-md</span>=<span class="string">&quot;_6&quot;</span> <span class="attr">class</span>=<span class="string">&quot;text-right&quot;</span>&gt;</span></span><br><span class="line">                @if (await AuthorizationService</span><br><span class="line">                    .IsGrantedAsync(BookStorePermissions.Authors.Create))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">abp-button</span> <span class="attr">id</span>=<span class="string">&quot;NewAuthorButton&quot;</span></span></span><br><span class="line"><span class="tag">                                <span class="attr">text</span>=<span class="string">&quot;@L[&quot;</span><span class="attr">NewAuthor</span>&quot;]<span class="attr">.Value</span>&quot;</span></span><br><span class="line"><span class="tag">                                <span class="attr">icon</span>=<span class="string">&quot;plus&quot;</span></span></span><br><span class="line"><span class="tag">                                <span class="attr">button-type</span>=<span class="string">&quot;Primary&quot;</span>/&gt;</span></span><br><span class="line">                &#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">abp-column</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">abp-row</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">abp-card-header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-card-body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-table</span> <span class="attr">striped-rows</span>=<span class="string">&quot;true&quot;</span> <span class="attr">id</span>=<span class="string">&quot;AuthorsTable&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">abp-table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">abp-card-body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">abp-card</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="IndexModel-cshtml-cs"><a href="#IndexModel-cshtml-cs" class="headerlink" title="IndexModel.cshtml.cs"></a>IndexModel.cshtml.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.RazorPages;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web.Pages.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">IndexModel</span> : <span class="title">PageModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnGet</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Index-js"><a href="#Index-js" class="headerlink" title="Index.js"></a>Index.js</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> l = abp.<span class="property">localization</span>.<span class="title function_">getResource</span>(<span class="string">&#x27;BookStore&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> createModal = <span class="keyword">new</span> abp.<span class="title class_">ModalManager</span>(abp.<span class="property">appPath</span> + <span class="string">&#x27;Authors/CreateModal&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> editModal = <span class="keyword">new</span> abp.<span class="title class_">ModalManager</span>(abp.<span class="property">appPath</span> + <span class="string">&#x27;Authors/EditModal&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> dataTable = $(<span class="string">&#x27;#AuthorsTable&#x27;</span>).<span class="title class_">DataTable</span>(</span><br><span class="line">        abp.<span class="property">libs</span>.<span class="property">datatables</span>.<span class="title function_">normalizeConfiguration</span>(&#123;</span><br><span class="line">            <span class="attr">serverSide</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">paging</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">order</span>: [[<span class="number">1</span>, <span class="string">&quot;asc&quot;</span>]],</span><br><span class="line">            <span class="attr">searching</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">scrollX</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">ajax</span>: abp.<span class="property">libs</span>.<span class="property">datatables</span>.<span class="title function_">createAjax</span>(acme.<span class="property">bookStore</span>.<span class="property">authors</span>.<span class="property">author</span>.<span class="property">getList</span>),</span><br><span class="line">            <span class="attr">columnDefs</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;Actions&#x27;</span>),</span><br><span class="line">                    <span class="attr">rowAction</span>: &#123;</span><br><span class="line">                        <span class="attr">items</span>:</span><br><span class="line">                            [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">text</span>: <span class="title function_">l</span>(<span class="string">&#x27;Edit&#x27;</span>),</span><br><span class="line">                                    <span class="attr">visible</span>:</span><br><span class="line">                                        abp.<span class="property">auth</span>.<span class="title function_">isGranted</span>(<span class="string">&#x27;BookStore.Authors.Edit&#x27;</span>),</span><br><span class="line">                                    <span class="attr">action</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                                        editModal.<span class="title function_">open</span>(&#123; <span class="attr">id</span>: data.<span class="property">record</span>.<span class="property">id</span> &#125;);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">text</span>: <span class="title function_">l</span>(<span class="string">&#x27;Delete&#x27;</span>),</span><br><span class="line">                                    <span class="attr">visible</span>:</span><br><span class="line">                                        abp.<span class="property">auth</span>.<span class="title function_">isGranted</span>(<span class="string">&#x27;BookStore.Authors.Delete&#x27;</span>),</span><br><span class="line">                                    <span class="attr">confirmMessage</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                                        <span class="keyword">return</span> <span class="title function_">l</span>(</span><br><span class="line">                                            <span class="string">&#x27;AuthorDeletionConfirmationMessage&#x27;</span>,</span><br><span class="line">                                            data.<span class="property">record</span>.<span class="property">name</span></span><br><span class="line">                                        );</span><br><span class="line">                                    &#125;,</span><br><span class="line">                                    <span class="attr">action</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                                        acme.<span class="property">bookStore</span>.<span class="property">authors</span>.<span class="property">author</span></span><br><span class="line">                                            .<span class="title function_">delete</span>(data.<span class="property">record</span>.<span class="property">id</span>)</span><br><span class="line">                                            .<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                                                abp.<span class="property">notify</span>.<span class="title function_">info</span>(</span><br><span class="line">                                                    <span class="title function_">l</span>(<span class="string">&#x27;SuccessfullyDeleted&#x27;</span>)</span><br><span class="line">                                                );</span><br><span class="line">                                                dataTable.<span class="property">ajax</span>.<span class="title function_">reload</span>();</span><br><span class="line">                                            &#125;);</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;Name&#x27;</span>),</span><br><span class="line">                    <span class="attr">data</span>: <span class="string">&quot;name&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;BirthDate&#x27;</span>),</span><br><span class="line">                    <span class="attr">data</span>: <span class="string">&quot;birthDate&quot;</span>,</span><br><span class="line">                    <span class="attr">dataFormat</span>: <span class="string">&quot;datetime&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    createModal.<span class="title function_">onResult</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        dataTable.<span class="property">ajax</span>.<span class="title function_">reload</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    editModal.<span class="title function_">onResult</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        dataTable.<span class="property">ajax</span>.<span class="title function_">reload</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    $(<span class="string">&#x27;#NewAuthorButton&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">        e.<span class="title function_">preventDefault</span>();</span><br><span class="line">        createModal.<span class="title function_">open</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>简单来说, 这个JavaScript页面:</p>
<ul>
<li>创建了一个具有 <code>操作</code>, <code>姓名</code> 和 <code>生日</code> 列的数据表格.<ul>
<li><code>Actions</code> 列用来添加 <em>编辑</em> 和 <em>删除</em> 操作.</li>
</ul>
</li>
<li>使用 <code>abp.ModalManager</code> 打开 <em>新建</em> 和 <em>编辑</em> 模态表单.</li>
</ul>
<p>这块代码与以前创建的图书页面非常相似, 所以我们不再赘述.</p>
<h4 id="本地化"><a href="#本地化" class="headerlink" title="本地化"></a>本地化</h4><p>这个页面使用了一些需要声明的本地化键. 打开 <code>Acme.BookStore.Domain.Shared</code> 项目中 <code>Localization/BookStore</code> 文件夹下的 <code>en.json</code> 文件, 加入以下条目:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;Menu:Authors&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Authors&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;Authors&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Authors&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;AuthorDeletionConfirmationMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Are you sure to delete the author &#x27;&#123;0&#125;&#x27;?&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;BirthDate&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Birth date&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;NewAuthor&quot;</span><span class="punctuation">:</span> <span class="string">&quot;New author&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>简体中文翻译请打开<code>zh-Hans.json</code>文件 ,并将”Texts”对象中对应的值替换为中文.</p>
</blockquote>
<p>注意我们加入了额外的键. 它们会在下面的小节中被使用.</p>
<h4 id="加入主菜单"><a href="#加入主菜单" class="headerlink" title="加入主菜单"></a>加入主菜单</h4><p>打开 <code>Acme.BookStore.Web</code> 项目的 <code>Menus</code> 文件夹中的 <code>BookStoreMenuContributor.cs</code> , 在 <code>ConfigureMainMenuAsync</code> 方法的结尾加入以下代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">await</span> context.IsGrantedAsync(BookStorePermissions.Authors.Default))</span><br><span class="line">&#123;</span><br><span class="line">    bookStoreMenu.AddItem(<span class="keyword">new</span> ApplicationMenuItem(</span><br><span class="line">        <span class="string">&quot;BooksStore.Authors&quot;</span>,</span><br><span class="line">        l[<span class="string">&quot;Menu:Authors&quot;</span>],</span><br><span class="line">        url: <span class="string">&quot;/Authors&quot;</span></span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行应用程序"><a href="#运行应用程序" class="headerlink" title="运行应用程序"></a>运行应用程序</h4><p>运行并登录应用程序. <strong>因为你还没有权限, 所以不能看见菜单项</strong>. 转到 <code>Identity/Roles</code> 页面, 点击 <em>操作</em> 按钮并选择<strong>管理员角色</strong>的<em>权限</em>操作。</p>
<p>如你所见, 管理员角色还没有<em>作者管理</em>权限. 单击复选框并保存, 赋予权限. <strong>刷新页面</strong>后, 你会在主菜单中的<em>图书商店</em>下看到<em>作者</em>菜单项。</p>
<p>页面是完全可以工作的, 除了 <em>新建作者</em> 和 <em>操作&#x2F;编辑</em>, 因为它们还没有实现 .</p>
<blockquote>
<p><strong>提示</strong>: 如果你在定义一个新权限后运行 <code>.DbMigrator</code> 控制台程序, 它会自动将这些权限赋予管理员角色, 你不需要手工赋予权限.</p>
</blockquote>
<h3 id="新建模态窗口"><a href="#新建模态窗口" class="headerlink" title="新建模态窗口"></a>新建模态窗口</h3><p>在 <code>Acme.BookStore.Web</code> 项目的 <code>Pages/Authors</code> 文件夹下创建一个 razor 页面 <code>CreateModal.cshtml</code>, 修改它的内容如下:</p>
<h4 id="CreateModal-cshtml"><a href="#CreateModal-cshtml" class="headerlink" title="CreateModal.cshtml"></a>CreateModal.cshtml</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@page</span><br><span class="line">@using Acme.BookStore.Localization</span><br><span class="line">@using Acme.BookStore.Web.Pages.Authors</span><br><span class="line">@using Microsoft.Extensions.Localization</span><br><span class="line">@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal</span><br><span class="line">@model CreateModalModel</span><br><span class="line">@inject IStringLocalizer<span class="tag">&lt;<span class="name">BookStoreResource</span>&gt;</span> L</span><br><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">asp-page</span>=<span class="string">&quot;/Authors/CreateModal&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-modal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-header</span> <span class="attr">title</span>=<span class="string">&quot;@L[&quot;</span><span class="attr">NewAuthor</span>&quot;]<span class="attr">.Value</span>&quot;&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.Name&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.BirthDate&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.ShortBio&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-footer</span> <span class="attr">buttons</span>=<span class="string">&quot;@(AbpModalButtons.Cancel|AbpModalButtons.Save)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">abp-modal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之前我们已经使用ABP框架的 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvVUkvQXNwTmV0Q29yZS9UYWctSGVscGVycy9EeW5hbWljLUZvcm1z">动态表单<i class="fa fa-external-link-alt"></i></span>开发了图书页面. 这里可以使用相同的方法, 但我们希望展示如何手工完成它. 实际上, 没有那么手工化, 因为在这个例子中我们使用了 <code>abp-input</code> 标签简化了表单元素的创建.</p>
<p>你当然可以使用标准Bootstrap HTML结构, 但是这需要写很多代码. <code>abp-input</code> 自动添加验证, 本地化和根据数据类型生成标准元素.</p>
<h4 id="CreateModal-cshtml-cs"><a href="#CreateModal-cshtml-cs" class="headerlink" title="CreateModal.cshtml.cs"></a>CreateModal.cshtml.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web.Pages.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateModalModel</span> : <span class="title">BookStorePageModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindProperty</span>]</span><br><span class="line">        <span class="keyword">public</span> CreateAuthorViewModel Author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorAppService _authorAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CreateModalModel</span>(<span class="params">IAuthorAppService authorAppService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorAppService = authorAppService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnGet</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Author = <span class="keyword">new</span> CreateAuthorViewModel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;IActionResult&gt; <span class="title">OnPostAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> dto = ObjectMapper.Map&lt;CreateAuthorViewModel, CreateAuthorDto&gt;(Author);</span><br><span class="line">            <span class="keyword">await</span> _authorAppService.CreateAsync(dto);</span><br><span class="line">            <span class="keyword">return</span> NoContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateAuthorViewModel</span></span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">StringLength(AuthorConsts.MaxNameLength)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">            <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">TextArea</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个页面模型类注入和使用 <code>IAuthorAppService</code> 创建新作者. 它和图书创建模型类之间主要的区别是这个模型类为视图模型声明了一个新类 <code>CreateAuthorViewModel</code>, 而不是重用 <code>CreateAuthorDto</code>.</p>
<p>这么做的主要原因是展示在页面中如何使用不同的模型. 但还有一个好处: 我们为类成员添加了两个不存在于 <code>CreateAuthorDto</code> 中的特性:</p>
<ul>
<li>为 <code>BirthDate</code> 添加 <code>[DataType(DataType.Date)]</code> 特性, 这会在UI为这个属性显示一个日期选择控件.</li>
<li>为 <code>ShortBio</code> 添加 <code>[TextArea]</code> 特性, 这会显示一个多行文本框, 而不是标准文本框.</li>
</ul>
<p>通过这种方式, 可以根据UI需求定制视图模型类, 而无需修改DTO. 这么做的一个结果是: 使用 <code>ObjectMapper</code> 将 <code>CreateAuthorViewModel</code> 映射到 <code>CreateAuthorDto</code>. 为了完成映射, 需要在 <code>BookStoreWebAutoMapperProfile</code> 构造函数中加入新的映射代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors; <span class="comment">// ADDED NAMESPACE IMPORT</span></span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> AutoMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookStoreWebAutoMapperProfile</span> : <span class="title">Profile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookStoreWebAutoMapperProfile</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateMap&lt;BookDto, CreateUpdateBookDto&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ADD a NEW MAPPING</span></span><br><span class="line">            CreateMap&lt;Pages.Authors.CreateModalModel.CreateAuthorViewModel,</span><br><span class="line">                      CreateAuthorDto&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当你重新运行应用程序后, 点击”新建作者” 按钮会打开一个新的模态窗口。</p>
<h3 id="编辑模态窗口"><a href="#编辑模态窗口" class="headerlink" title="编辑模态窗口"></a>编辑模态窗口</h3><p>在 <code>Acme.BookStore.Web</code> 项目的 <code>Pages/Authors</code> 文件夹下创建一个 razor 页面 <code>EditModal.cshtml</code>, 修改它的内容如下:</p>
<h4 id="EditModal-cshtml"><a href="#EditModal-cshtml" class="headerlink" title="EditModal.cshtml"></a>EditModal.cshtml</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@page</span><br><span class="line">@using Acme.BookStore.Localization</span><br><span class="line">@using Acme.BookStore.Web.Pages.Authors</span><br><span class="line">@using Microsoft.Extensions.Localization</span><br><span class="line">@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal</span><br><span class="line">@model EditModalModel</span><br><span class="line">@inject IStringLocalizer<span class="tag">&lt;<span class="name">BookStoreResource</span>&gt;</span> L</span><br><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">asp-page</span>=<span class="string">&quot;/Authors/EditModal&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-modal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-header</span> <span class="attr">title</span>=<span class="string">&quot;@L[&quot;</span><span class="attr">Update</span>&quot;]<span class="attr">.Value</span>&quot;&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.Id&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.Name&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.BirthDate&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-input</span> <span class="attr">asp-for</span>=<span class="string">&quot;Author.ShortBio&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-footer</span> <span class="attr">buttons</span>=<span class="string">&quot;@(AbpModalButtons.Cancel|AbpModalButtons.Save)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">abp-modal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="EditModal-cshtml-cs"><a href="#EditModal-cshtml-cs" class="headerlink" title="EditModal.cshtml.cs"></a>EditModal.cshtml.cs</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web.Pages.Authors</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditModalModel</span> : <span class="title">BookStorePageModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindProperty</span>]</span><br><span class="line">        <span class="keyword">public</span> EditAuthorViewModel Author &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorAppService _authorAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EditModalModel</span>(<span class="params">IAuthorAppService authorAppService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorAppService = authorAppService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnGetAsync</span>(<span class="params">Guid id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> authorDto = <span class="keyword">await</span> _authorAppService.GetAsync(id);</span><br><span class="line">            Author = ObjectMapper.Map&lt;AuthorDto, EditAuthorViewModel&gt;(authorDto);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IActionResult</span>&gt; <span class="title">OnPostAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _authorAppService.UpdateAsync(</span><br><span class="line">                Author.Id,</span><br><span class="line">                ObjectMapper.Map&lt;EditAuthorViewModel, UpdateAuthorDto&gt;(Author)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NoContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditAuthorViewModel</span></span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">HiddenInput</span>]</span><br><span class="line">            <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">StringLength(AuthorConsts.MaxNameLength)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">            <span class="keyword">public</span> DateTime BirthDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">TextArea</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ShortBio &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类与 <code>CreateModal.cshtml.cs</code> 类似, 主要不同是:</p>
<ul>
<li>使用 <code>IAuthorAppService.GetAsync(...)</code> 方法从应用层获取正在编辑的作者.</li>
<li><code>EditAuthorViewModel</code> 拥有一个额外的 <code>Id</code> 属性, 它被 <code>[HiddenInput]</code> 特性标记, 会为这个属性在页面上创建一个隐藏输入框.</li>
</ul>
<p>这个类要求在 <code>BookStoreWebAutoMapperProfile</code> 类中添加两个对象映射声明:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> AutoMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookStoreWebAutoMapperProfile</span> : <span class="title">Profile</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookStoreWebAutoMapperProfile</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            CreateMap&lt;BookDto, CreateUpdateBookDto&gt;();</span><br><span class="line"></span><br><span class="line">            CreateMap&lt;Pages.Authors.CreateModalModel.CreateAuthorViewModel,</span><br><span class="line">                      CreateAuthorDto&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ADD THESE NEW MAPPINGS</span></span><br><span class="line">            CreateMap&lt;AuthorDto, Pages.Authors.EditModalModel.EditAuthorViewModel&gt;();</span><br><span class="line">            CreateMap&lt;Pages.Authors.EditModalModel.EditAuthorViewModel,</span><br><span class="line">                      UpdateAuthorDto&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="作者与图书的关系"><a href="#作者与图书的关系" class="headerlink" title="作者与图书的关系"></a>作者与图书的关系</h2><p>我们已经为图书管理应用程序创建了 <code>图书</code> 和 <code>作者</code> 功能. 然而, 这些实体间还没有关联.</p>
<p>在本章, 我们会在 <code>作者</code> 和 <code>图书</code> 实体间建立 <strong>1 对 N</strong> 的关系.</p>
<h3 id="在图书实体中加入关系"><a href="#在图书实体中加入关系" class="headerlink" title="在图书实体中加入关系"></a>在图书实体中加入关系</h3><p>打开 <code>Acme.BookStore.Domain</code> 项目中的 <code>Books/Book.cs</code>, 在 <code>Book</code> 实体中加入下列属性:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在本章中, 我们选择不在 <code>Book</code> 类中加入 <code>Author</code> 实体的 <strong>导航属性</strong> (例如 <code>public Author Author &#123; get; set; &#125;</code>). 这是为了遵循 DDD 最佳实践 (规则: 仅通过id引用其它聚合对象). 但是, 你自己可以添加这样的导航属性, 并为EF Core配置它. 这样, 你在获取图书和它们的作者时就不需要写join查询了(如同下面我们做的一样), 这会使代码更简洁一些.</p>
</blockquote>
<h3 id="数据库-数据迁移"><a href="#数据库-数据迁移" class="headerlink" title="数据库 &amp; 数据迁移"></a>数据库 &amp; 数据迁移</h3><p>为 <code>Book</code> 实体新增一个不为空的 <code>AuthorId</code> 属性. 但是, 数据库中<strong>已存在的图书怎么办</strong>? 它们没有 <code>AuthorId</code>s, 当我们尝试运行应用程序时会出问题.</p>
<p>这是一个 <strong>典型的迁移问题</strong>, 解决方案依赖于你的具体情况;</p>
<ul>
<li>如果你还没有发布应用程序到生产环境, 你可以直接删除数据库中的图书数据, 甚至你可以删除开发环境中的整个数据库.</li>
<li>你可以在数据迁移或生成种子阶段使用代码更新已有数据.</li>
<li>你可以手工处理这些数据.</li>
</ul>
<p>我们倾向于 <strong>删除数据库</strong> (你可以在 <em>Package Manager 控制台</em>中运行 <code>Drop-Database</code>, 因为这只是个示例项目, 数据丢失无关紧要.</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef database drop</span><br></pre></td></tr></table></figure>

<h4 id="更新-EF-Core-映射"><a href="#更新-EF-Core-映射" class="headerlink" title="更新 EF Core 映射"></a>更新 EF Core 映射</h4><p>定位到 <code>Acme.BookStore.EntityFrameworkCore</code> 项目的 <code>EntityFrameworkCore</code> 文件夹下的 <code>BookStoreDbContext</code> 类的 <code>OnModelCreating</code> 方法, 修改 <code>builder.Entity&lt;Book&gt;</code> 部分如下:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">builder.Entity&lt;Book&gt;(b =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    b.ToTable(BookStoreConsts.DbTablePrefix + <span class="string">&quot;Books&quot;</span>, BookStoreConsts.DbSchema);</span><br><span class="line">    b.ConfigureByConvention(); <span class="comment">//auto configure for the base class props</span></span><br><span class="line">    b.Property(x =&gt; x.Name).IsRequired().HasMaxLength(<span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ADD THE MAPPING FOR THE RELATION</span></span><br><span class="line">    b.HasOne&lt;Author&gt;().WithMany().HasForeignKey(x =&gt; x.AuthorId).IsRequired();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="新增-EF-Core-迁移"><a href="#新增-EF-Core-迁移" class="headerlink" title="新增 EF Core 迁移"></a>新增 EF Core 迁移</h4><p>启动解决方案被配置为使用 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1pY3Jvc29mdC5jb20vZW4tdXMvZWYvY29yZS9tYW5hZ2luZy1zY2hlbWFzL21pZ3JhdGlvbnMv">Entity Framework Core Code First Migrations<i class="fa fa-external-link-alt"></i></span>. 因为我们修改了数据库映射配置, 我们需要新建一个迁移并应用于数据库.</p>
<p>在 <code>Acme.BookStore.EntityFrameworkCore</code> 项目的文件目录打开命令行终端, 输入命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dotnet ef migrations add Added_AuthorId_To_Book</span><br></pre></td></tr></table></figure>

<p>这会创建一个新的迁移类, 在它的 <code>Up</code> 方法中使用下列方法:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">migrationBuilder.AddColumn&lt;Guid&gt;(</span><br><span class="line">    name: <span class="string">&quot;AuthorId&quot;</span>,</span><br><span class="line">    table: <span class="string">&quot;AppBooks&quot;</span>,</span><br><span class="line">    nullable: <span class="literal">false</span>,</span><br><span class="line">    defaultValue: <span class="keyword">new</span> Guid(<span class="string">&quot;00000000-0000-0000-0000-000000000000&quot;</span>));</span><br><span class="line"></span><br><span class="line">migrationBuilder.CreateIndex(</span><br><span class="line">    name: <span class="string">&quot;IX_AppBooks_AuthorId&quot;</span>,</span><br><span class="line">    table: <span class="string">&quot;AppBooks&quot;</span>,</span><br><span class="line">    column: <span class="string">&quot;AuthorId&quot;</span>);</span><br><span class="line"></span><br><span class="line">migrationBuilder.AddForeignKey(</span><br><span class="line">    name: <span class="string">&quot;FK_AppBooks_AppAuthors_AuthorId&quot;</span>,</span><br><span class="line">    table: <span class="string">&quot;AppBooks&quot;</span>,</span><br><span class="line">    column: <span class="string">&quot;AuthorId&quot;</span>,</span><br><span class="line">    principalTable: <span class="string">&quot;AppAuthors&quot;</span>,</span><br><span class="line">    principalColumn: <span class="string">&quot;Id&quot;</span>,</span><br><span class="line">    onDelete: ReferentialAction.Cascade);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>AppBooks</code> 表增加一个 <code>AuthorId</code> 字段 .</li>
<li>根据 <code>AuthorId</code> 字段新建一个索引.</li>
<li>声明到 <code>AppAuthors</code> 表的外键.</li>
</ul>
<h3 id="修改数据种子"><a href="#修改数据种子" class="headerlink" title="修改数据种子"></a>修改数据种子</h3><p>因为 <code>AuthorId</code> 是 <code>Book</code> 实体的不可为空属性, 当前的数据种子代码不能工作. 打开 <code>Acme.BookStore.Domain</code> 项目中的 <code>BookStoreDataSeederContributor</code>, 修改成以下代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Data;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.DependencyInjection;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookStoreDataSeederContributor</span></span><br><span class="line">        : <span class="title">IDataSeedContributor</span>, <span class="title">ITransientDependency</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IRepository&lt;Book, Guid&gt; _bookRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorRepository _authorRepository;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> AuthorManager _authorManager;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookStoreDataSeederContributor</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IRepository&lt;Book, Guid&gt; bookRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">            IAuthorRepository authorRepository,</span></span></span><br><span class="line"><span class="params"><span class="function">            AuthorManager authorManager</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _bookRepository = bookRepository;</span><br><span class="line">            _authorRepository = authorRepository;</span><br><span class="line">            _authorManager = authorManager;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">SeedAsync</span>(<span class="params">DataSeedContext context</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">await</span> _bookRepository.GetCountAsync() &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> orwell = <span class="keyword">await</span> _authorRepository.InsertAsync(</span><br><span class="line">                <span class="keyword">await</span> _authorManager.CreateAsync(</span><br><span class="line">                    <span class="string">&quot;George Orwell&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> DateTime(<span class="number">1903</span>, <span class="number">06</span>, <span class="number">25</span>),</span><br><span class="line">                    <span class="string">&quot;Orwell produced literary criticism and poetry, fiction and polemical journalism; and is best known for the allegorical novella Animal Farm (1945) and the dystopian novel Nineteen Eighty-Four (1949).&quot;</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> douglas = <span class="keyword">await</span> _authorRepository.InsertAsync(</span><br><span class="line">                <span class="keyword">await</span> _authorManager.CreateAsync(</span><br><span class="line">                    <span class="string">&quot;Douglas Adams&quot;</span>,</span><br><span class="line">                    <span class="keyword">new</span> DateTime(<span class="number">1952</span>, <span class="number">03</span>, <span class="number">11</span>),</span><br><span class="line">                    <span class="string">&quot;Douglas Adams was an English author, screenwriter, essayist, humorist, satirist and dramatist. Adams was an advocate for environmentalism and conservation, a lover of fast cars, technological innovation and the Apple Macintosh, and a self-proclaimed &#x27;radical atheist&#x27;.&quot;</span></span><br><span class="line">                )</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> _bookRepository.InsertAsync(</span><br><span class="line">                <span class="keyword">new</span> Book</span><br><span class="line">                &#123;</span><br><span class="line">                    AuthorId = orwell.Id, <span class="comment">// SET THE AUTHOR</span></span><br><span class="line">                    Name = <span class="string">&quot;1984&quot;</span>,</span><br><span class="line">                    Type = BookType.Dystopia,</span><br><span class="line">                    PublishDate = <span class="keyword">new</span> DateTime(<span class="number">1949</span>, <span class="number">6</span>, <span class="number">8</span>),</span><br><span class="line">                    Price = <span class="number">19.84f</span></span><br><span class="line">                &#125;,</span><br><span class="line">                autoSave: <span class="literal">true</span></span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> _bookRepository.InsertAsync(</span><br><span class="line">                <span class="keyword">new</span> Book</span><br><span class="line">                &#123;</span><br><span class="line">                    AuthorId = douglas.Id, <span class="comment">// SET THE AUTHOR</span></span><br><span class="line">                    Name = <span class="string">&quot;The Hitchhiker&#x27;s Guide to the Galaxy&quot;</span>,</span><br><span class="line">                    Type = BookType.ScienceFiction,</span><br><span class="line">                    PublishDate = <span class="keyword">new</span> DateTime(<span class="number">1995</span>, <span class="number">9</span>, <span class="number">27</span>),</span><br><span class="line">                    Price = <span class="number">42.0f</span></span><br><span class="line">                &#125;,</span><br><span class="line">                autoSave: <span class="literal">true</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>唯一的区别是设置 <code>Book</code> 实体的 <code>AuthorId</code> 属性.</p>
<blockquote>
<p>执行 <code>DbMigrator</code> 前删除已有图书或数据库. 参阅上面的 <em>数据库 &amp; 数据迁移</em> 小节获取详细信息.</p>
</blockquote>
<p>你现在可以运行 <code>.DbMigrator</code> 控制台应用程序, <strong>迁移</strong> <strong>数据库 schema</strong> 并生成 <strong>种子</strong> 初始数据.</p>
<h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><p>我们将修改 <code>BookAppService</code>, 支持作者关系.</p>
<h4 id="数据传输对象"><a href="#数据传输对象" class="headerlink" title="数据传输对象"></a>数据传输对象</h4><p>让我们从DTOs开始.</p>
<h5 id="BookDto"><a href="#BookDto" class="headerlink" title="BookDto"></a>BookDto</h5><p>打开 <code>Acme.BookStore.Application.Contracts</code> 项目的 <code>Books</code> 文件夹下的 <code>BookDto</code> 类, 添加如下属性:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> AuthorName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>最终的 <code>BookDto</code> 类应该如下:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookDto</span> : <span class="title">AuditedEntityDto</span>&lt;<span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> AuthorName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> BookType Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DateTime PublishDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">float</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CreateUpdateBookDto"><a href="#CreateUpdateBookDto" class="headerlink" title="CreateUpdateBookDto"></a>CreateUpdateBookDto</h5><p>打开 <code>Acme.BookStore.Application.Contracts</code> 项目的 <code>Books</code> 文件夹下的 <code>CreateUpdateBookDto</code> 类, 添加 <code>AuthorId</code> 属性:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<h5 id="AuthorLookupDto"><a href="#AuthorLookupDto" class="headerlink" title="AuthorLookupDto"></a>AuthorLookupDto</h5><p>在 <code>Acme.BookStore.Application.Contracts</code> 项目的 <code>Books</code> 文件夹下新建一个类 <code>AuthorLookupDto</code>:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AuthorLookupDto</span> : <span class="title">EntityDto</span>&lt;<span class="title">Guid</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它会被一个将要添加到 <code>IBookAppService</code> 的新方法使用.</p>
<h4 id="IBookAppService"><a href="#IBookAppService" class="headerlink" title="IBookAppService"></a>IBookAppService</h4><p>打开 <code>Acme.BookStore.Application.Contracts</code> 项目的 <code>Books</code> 文件夹下的 <code>IBookAppService</code> 接口, 添加一个名为 <code>GetAuthorLookupAsync</code> 的新方法:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Services;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IBookAppService</span> :</span><br><span class="line">        <span class="title">ICrudAppService</span>&lt; //<span class="title">Defines</span> <span class="title">CRUD</span> <span class="title">methods</span></span><br><span class="line">            <span class="title">BookDto</span>, //<span class="title">Used</span> <span class="title">to</span> <span class="title">show</span> <span class="title">books</span></span><br><span class="line">            <span class="title">Guid</span>, //<span class="title">Primary</span> <span class="title">key</span> <span class="title">of</span> <span class="title">the</span> <span class="title">book</span> <span class="title">entity</span></span><br><span class="line">            <span class="title">PagedAndSortedResultRequestDto</span>, //<span class="title">Used</span> <span class="title">for</span> <span class="title">paging</span>/<span class="title">sorting</span></span><br><span class="line">            <span class="title">CreateUpdateBookDto</span>&gt; <span class="comment">//Used to create/update a book</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ADD the NEW METHOD</span></span><br><span class="line">        Task&lt;ListResultDto&lt;AuthorLookupDto&gt;&gt; GetAuthorLookupAsync();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个新方法将被UI用来获取作者列表, 填充一个下拉框. 使用这个下拉框选择图书作者.</p>
<h4 id="BookAppService"><a href="#BookAppService" class="headerlink" title="BookAppService"></a>BookAppService</h4><p>打开 <code>Acme.BookStore.Application</code> 项目的 <code>Books</code> 文件夹下的 <code>BookAppService</code> 类, 更新为以下代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Linq.Dynamic.Core;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Permissions;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Authorization;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Services;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Entities;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Domain.Repositories;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Authorize(BookStorePermissions.Books.Default)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookAppService</span> :</span><br><span class="line">        <span class="title">CrudAppService</span>&lt;</span><br><span class="line">            <span class="title">Book</span>, //<span class="title">The</span> <span class="title">Book</span> <span class="title">entity</span></span><br><span class="line">            <span class="title">BookDto</span>, //<span class="title">Used</span> <span class="title">to</span> <span class="title">show</span> <span class="title">books</span></span><br><span class="line">            <span class="title">Guid</span>, //<span class="title">Primary</span> <span class="title">key</span> <span class="title">of</span> <span class="title">the</span> <span class="title">book</span> <span class="title">entity</span></span><br><span class="line">            <span class="title">PagedAndSortedResultRequestDto</span>, //<span class="title">Used</span> <span class="title">for</span> <span class="title">paging</span>/<span class="title">sorting</span></span><br><span class="line">            <span class="title">CreateUpdateBookDto</span>&gt;, <span class="comment">//Used to create/update a book</span></span><br><span class="line">        <span class="title">IBookAppService</span> <span class="comment">//implement the IBookAppService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorRepository _authorRepository;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookAppService</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IRepository&lt;Book, Guid&gt; repository,</span></span></span><br><span class="line"><span class="params"><span class="function">            IAuthorRepository authorRepository</span>)</span></span><br><span class="line"><span class="function">            : <span class="title">base</span>(<span class="params">repository</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _authorRepository = authorRepository;</span><br><span class="line">            GetPolicyName = BookStorePermissions.Books.Default;</span><br><span class="line">            GetListPolicyName = BookStorePermissions.Books.Default;</span><br><span class="line">            CreatePolicyName = BookStorePermissions.Books.Create;</span><br><span class="line">            UpdatePolicyName = BookStorePermissions.Books.Edit;</span><br><span class="line">            DeletePolicyName = BookStorePermissions.Books.Delete;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task&lt;BookDto&gt; <span class="title">GetAsync</span>(<span class="params">Guid id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get the IQueryable&lt;Book&gt; from the repository</span></span><br><span class="line">            <span class="keyword">var</span> queryable = <span class="keyword">await</span> Repository.GetQueryableAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Prepare a query to join books and authors</span></span><br><span class="line">            <span class="keyword">var</span> query = <span class="keyword">from</span> book <span class="keyword">in</span> queryable</span><br><span class="line">                <span class="keyword">join</span> author <span class="keyword">in</span> <span class="keyword">await</span> _authorRepository.GetQueryableAsync() <span class="keyword">on</span> book.AuthorId <span class="keyword">equals</span> author.Id</span><br><span class="line">                <span class="keyword">where</span> book.Id == id</span><br><span class="line">                <span class="keyword">select</span> <span class="keyword">new</span> &#123; book, author &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Execute the query and get the book with author</span></span><br><span class="line">            <span class="keyword">var</span> queryResult = <span class="keyword">await</span> AsyncExecuter.FirstOrDefaultAsync(query);</span><br><span class="line">            <span class="keyword">if</span> (queryResult == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EntityNotFoundException(<span class="keyword">typeof</span>(Book), id);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> bookDto = ObjectMapper.Map&lt;Book, BookDto&gt;(queryResult.book);</span><br><span class="line">            bookDto.AuthorName = queryResult.author.Name;</span><br><span class="line">            <span class="keyword">return</span> bookDto;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">async</span> Task&lt;PagedResultDto&lt;BookDto&gt;&gt; GetListAsync(PagedAndSortedResultRequestDto input)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Get the IQueryable&lt;Book&gt; from the repository</span></span><br><span class="line">            <span class="keyword">var</span> queryable = <span class="keyword">await</span> Repository.GetQueryableAsync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Prepare a query to join books and authors</span></span><br><span class="line">            <span class="keyword">var</span> query = <span class="keyword">from</span> book <span class="keyword">in</span> queryable</span><br><span class="line">                <span class="keyword">join</span> author <span class="keyword">in</span> <span class="keyword">await</span> _authorRepository.GetQueryableAsync() <span class="keyword">on</span> book.AuthorId <span class="keyword">equals</span> author.Id</span><br><span class="line">                <span class="keyword">select</span> <span class="keyword">new</span> &#123;book, author&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Paging</span></span><br><span class="line">            query = query</span><br><span class="line">                .OrderBy(NormalizeSorting(input.Sorting))</span><br><span class="line">                .Skip(input.SkipCount)</span><br><span class="line">                .Take(input.MaxResultCount);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Execute the query and get a list</span></span><br><span class="line">            <span class="keyword">var</span> queryResult = <span class="keyword">await</span> AsyncExecuter.ToListAsync(query);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Convert the query result to a list of BookDto objects</span></span><br><span class="line">            <span class="keyword">var</span> bookDtos = queryResult.Select(x =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> bookDto = ObjectMapper.Map&lt;Book, BookDto&gt;(x.book);</span><br><span class="line">                bookDto.AuthorName = x.author.Name;</span><br><span class="line">                <span class="keyword">return</span> bookDto;</span><br><span class="line">            &#125;).ToList();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Get the total count with another query</span></span><br><span class="line">            <span class="keyword">var</span> totalCount = <span class="keyword">await</span> Repository.GetCountAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PagedResultDto&lt;BookDto&gt;(</span><br><span class="line">                totalCount,</span><br><span class="line">                bookDtos</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ListResultDto&lt;AuthorLookupDto&gt;&gt; GetAuthorLookupAsync()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> authors = <span class="keyword">await</span> _authorRepository.GetListAsync();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ListResultDto&lt;AuthorLookupDto&gt;(</span><br><span class="line">                ObjectMapper.Map&lt;List&lt;Author&gt;, List&lt;AuthorLookupDto&gt;&gt;(authors)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">NormalizeSorting</span>(<span class="params"><span class="built_in">string</span> sorting</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (sorting.IsNullOrEmpty())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">$&quot;book.<span class="subst">&#123;<span class="keyword">nameof</span>(Book.Name)&#125;</span>&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sorting.Contains(<span class="string">&quot;authorName&quot;</span>, StringComparison.OrdinalIgnoreCase))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> sorting.Replace(</span><br><span class="line">                    <span class="string">&quot;authorName&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;author.Name&quot;</span>,</span><br><span class="line">                    StringComparison.OrdinalIgnoreCase</span><br><span class="line">                );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="string">$&quot;book.<span class="subst">&#123;sorting&#125;</span>&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们做了以下修改:</p>
<ul>
<li>给所有新建&#x2F;覆写的方法增加 <code>[Authorize(BookStorePermissions.Books.Default)]</code> 进行授权(当授权特性应用于类时, 它对这个类的所有方法有效).</li>
<li>注入 <code>IAuthorRepository</code>, 从作者中查询.</li>
<li>覆写基类 <code>CrudAppService</code> 的 <code>GetAsync</code> 方法. 这个方法根据给定的 <code>id</code> 返回单一 <code>BookDto</code> 对象.<ul>
<li>使用一个简单的LINQ表达式关联图书和作者, 根据给定的图书id查询, 查询结果同时包含图书和作者.</li>
<li>使用 <code>AsyncExecuter.FirstOrDefaultAsync(...)</code> 执行查询并得到一个结果. 这是一种无需依赖database provider API, 使用异步LINQ扩展的方法. 参阅 <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmFicC5pby96aC1IYW5zL2FicC9sYXRlc3QvUmVwb3NpdG9yaWVz">repository文档<i class="fa fa-external-link-alt"></i></span>以理解我们为什么使用它.</li>
<li>如果请求的图书在数据库中不存在, 抛出一个 <code>EntityNotFoundException</code>, 这会导致一个 <code>HTTP 404</code> (not found) 状态码.</li>
<li>最后, 使用 <code>ObjectMapper</code>创建一个 <code>BookDto</code> 对象, 然后手工给 <code>AuthorName</code> 赋值.</li>
</ul>
</li>
<li>覆写 <code>CrudAppService</code> 基类的 <code>GetListAsync</code> 方法, 返回图书列表. 逻辑与前一个方法类似, 所以很容易理解.</li>
<li>新建一个方法: <code>GetAuthorLookupAsync</code>. 这个方法只是简单地获取所有作者. UI使用这个方法填充一个下拉框, 当编辑图书时用来选择作者.</li>
</ul>
<h4 id="对象到对象映射映射"><a href="#对象到对象映射映射" class="headerlink" title="对象到对象映射映射"></a>对象到对象映射映射</h4><p>引入 <code>AuthorLookupDto</code> 类, 在 <code>GetAuthorLookupAsync</code> 方法中使用对象映射. 所以, 我们需要在 <code>Acme.BookStore.Application</code> 项目的 <code>BookStoreApplicationAutoMapperProfile.cs</code> 文件中加入一个新的映射定义.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CreateMap&lt;Author, AuthorLookupDto&gt;();</span><br></pre></td></tr></table></figure>

<h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><p>因为修改了 <code>AuthorAppService</code>, 一些单元测试失败了. 打开 <code>Acme.BookStore.Application.Tests</code> 项目的 <code>Books</code> 目录中的 <code>BookAppService_Tests</code>, 修改成以下代码:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Authors;</span><br><span class="line"><span class="keyword">using</span> Shouldly;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Application.Dtos;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.Validation;</span><br><span class="line"><span class="keyword">using</span> Xunit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BookAppService_Tests</span> : <span class="title">BookStoreApplicationTestBase</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IBookAppService _bookAppService;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IAuthorAppService _authorAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">BookAppService_Tests</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            _bookAppService = GetRequiredService&lt;IBookAppService&gt;();</span><br><span class="line">            _authorAppService = GetRequiredService&lt;IAuthorAppService&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Get_List_Of_Books</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Act</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> _bookAppService.GetListAsync(</span><br><span class="line">                <span class="keyword">new</span> PagedAndSortedResultRequestDto()</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Assert</span></span><br><span class="line">            result.TotalCount.ShouldBeGreaterThan(<span class="number">0</span>);</span><br><span class="line">            result.Items.ShouldContain(b =&gt; b.Name == <span class="string">&quot;1984&quot;</span> &amp;&amp;</span><br><span class="line">                                       b.AuthorName == <span class="string">&quot;George Orwell&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Create_A_Valid_Book</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> authors = <span class="keyword">await</span> _authorAppService.GetListAsync(<span class="keyword">new</span> GetAuthorListDto());</span><br><span class="line">            <span class="keyword">var</span> firstAuthor = authors.Items.First();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Act</span></span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> _bookAppService.CreateAsync(</span><br><span class="line">                <span class="keyword">new</span> CreateUpdateBookDto</span><br><span class="line">                &#123;</span><br><span class="line">                    AuthorId = firstAuthor.Id,</span><br><span class="line">                    Name = <span class="string">&quot;New test book 42&quot;</span>,</span><br><span class="line">                    Price = <span class="number">10</span>,</span><br><span class="line">                    PublishDate = System.DateTime.Now,</span><br><span class="line">                    Type = BookType.ScienceFiction</span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Assert</span></span><br><span class="line">            result.Id.ShouldNotBe(Guid.Empty);</span><br><span class="line">            result.Name.ShouldBe(<span class="string">&quot;New test book 42&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">Fact</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">Should_Not_Create_A_Book_Without_Name</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> exception = <span class="keyword">await</span> Assert.ThrowsAsync&lt;AbpValidationException&gt;(<span class="keyword">async</span> () =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">await</span> _bookAppService.CreateAsync(</span><br><span class="line">                    <span class="keyword">new</span> CreateUpdateBookDto</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        Price = <span class="number">10</span>,</span><br><span class="line">                        PublishDate = DateTime.Now,</span><br><span class="line">                        Type = BookType.ScienceFiction</span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            exception.ValidationErrors</span><br><span class="line">                .ShouldContain(err =&gt; err.MemberNames.Any(m =&gt; m == <span class="string">&quot;Name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 <code>Should_Get_List_Of_Books</code> 中的断言条件, 从 <code>b =&gt; b.Name == &quot;1984&quot;</code> 修改为 <code>b =&gt; b.Name == &quot;1984&quot; &amp;&amp; b.AuthorName == &quot;George Orwell&quot;</code>, 检查用户名是否被填充.</li>
<li>修改 <code>Should_Create_A_Valid_Book</code> 方法, 当新建图书时, 设置 <code>AuthorId</code>, 因为它现在是不可为空的了.</li>
</ul>
<h3 id="用户页面"><a href="#用户页面" class="headerlink" title="用户页面"></a>用户页面</h3><h4 id="图书列表"><a href="#图书列表" class="headerlink" title="图书列表"></a>图书列表</h4><p>图书列表页面的修改很小. 打开 <code>Acme.BookStore.Web</code> 项目上的 <code>Pages/Books/Index.js</code>, 在 <code>name</code> and <code>type</code> 列之间加入如下列定义:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;Name&#x27;</span>),</span><br><span class="line">    <span class="attr">data</span>: <span class="string">&quot;name&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// ADDED the NEW AUTHOR NAME COLUMN</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;Author&#x27;</span>),</span><br><span class="line">    <span class="attr">data</span>: <span class="string">&quot;authorName&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">title</span>: <span class="title function_">l</span>(<span class="string">&#x27;Type&#x27;</span>),</span><br><span class="line">    <span class="attr">data</span>: <span class="string">&quot;type&quot;</span>,</span><br><span class="line">    <span class="attr">render</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">l</span>(<span class="string">&#x27;Enum:BookType:&#x27;</span> + data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>运行应用程序, 你会在表格中看到 <em>Author</em> 列:</p>
<h4 id="CreateModal"><a href="#CreateModal" class="headerlink" title="CreateModal"></a>CreateModal</h4><p>打开 <code>Acme.BookStore.Web</code> 项目中的 <code>Pages/Books/CreateModal.cshtml.cs</code>, 修改文件内容为:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Rendering;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web.Pages.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateModalModel</span> : <span class="title">BookStorePageModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindProperty</span>]</span><br><span class="line">        <span class="keyword">public</span> CreateBookViewModel Book &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;SelectListItem&gt; Authors &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IBookAppService _bookAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CreateModalModel</span>(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="function">            IBookAppService bookAppService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _bookAppService = bookAppService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnGetAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            Book = <span class="keyword">new</span> CreateBookViewModel();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> authorLookup = <span class="keyword">await</span> _bookAppService.GetAuthorLookupAsync();</span><br><span class="line">            Authors = authorLookup.Items</span><br><span class="line">                .Select(x =&gt; <span class="keyword">new</span> SelectListItem(x.Name, x.Id.ToString()))</span><br><span class="line">                .ToList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IActionResult</span>&gt; <span class="title">OnPostAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _bookAppService.CreateAsync(</span><br><span class="line">                ObjectMapper.Map&lt;CreateBookViewModel, CreateUpdateBookDto&gt;(Book)</span><br><span class="line">                );</span><br><span class="line">            <span class="keyword">return</span> NoContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CreateBookViewModel</span></span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">SelectItems(nameof(Authors))</span>]</span><br><span class="line">            [<span class="meta">DisplayName(<span class="string">&quot;Author&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">StringLength(128)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            <span class="keyword">public</span> BookType Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = BookType.Undefined;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">            <span class="keyword">public</span> DateTime PublishDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = DateTime.Now;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">float</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将 <code>Book</code> 属性的类型从 <code>CreateUpdateBookDto</code> 修改为这个文件中新定义的 <code>CreateBookViewModel</code> 类. 这个修改的主要动机是根据UI需求自定义模型类. 我们不希望在 <code>CreateUpdateBookDto</code> 类中使用UI相关的 <code>[SelectItems(nameof(Authors))]</code> 和 <code>[DisplayName(&quot;Author&quot;)]</code> 特性.</li>
<li>新增 <code>Authors</code> 属性, 在 <code>OnGetAsync</code> 方法中使用前面定义的 <code>IBookAppService.GetAuthorLookupAsync</code> 方法填充它.</li>
<li>修改 <code>OnPostAsync</code> 方法, 映射 <code>CreateBookViewModel</code> 对象到 <code>CreateUpdateBookDto</code> 对象, 因为 <code>IBookAppService.CreateAsync</code> 需要一个这种类型的参数.</li>
</ul>
<h4 id="EditModal"><a href="#EditModal" class="headerlink" title="EditModal"></a>EditModal</h4><p>打开 <code>Acme.BookStore.Web</code> 项目中的 <code>Pages/Books/EditModal.cshtml.cs</code>, 修改文件内容为:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Acme.BookStore.Books;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc.Rendering;</span><br><span class="line"><span class="keyword">using</span> Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Form;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Acme.BookStore.Web.Pages.Books</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditModalModel</span> : <span class="title">BookStorePageModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">BindProperty</span>]</span><br><span class="line">        <span class="keyword">public</span> EditBookViewModel Book &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;SelectListItem&gt; Authors &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">readonly</span> IBookAppService _bookAppService;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EditModalModel</span>(<span class="params">IBookAppService bookAppService</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            _bookAppService = bookAppService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">OnGetAsync</span>(<span class="params">Guid id</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> bookDto = <span class="keyword">await</span> _bookAppService.GetAsync(id);</span><br><span class="line">            Book = ObjectMapper.Map&lt;BookDto, EditBookViewModel&gt;(bookDto);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> authorLookup = <span class="keyword">await</span> _bookAppService.GetAuthorLookupAsync();</span><br><span class="line">            Authors = authorLookup.Items</span><br><span class="line">                .Select(x =&gt; <span class="keyword">new</span> SelectListItem(x.Name, x.Id.ToString()))</span><br><span class="line">                .ToList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> <span class="title">Task</span>&lt;<span class="title">IActionResult</span>&gt; <span class="title">OnPostAsync</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">await</span> _bookAppService.UpdateAsync(</span><br><span class="line">                Book.Id,</span><br><span class="line">                ObjectMapper.Map&lt;EditBookViewModel, CreateUpdateBookDto&gt;(Book)</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NoContent();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EditBookViewModel</span></span><br><span class="line">        &#123;</span><br><span class="line">            [<span class="meta">HiddenInput</span>]</span><br><span class="line">            <span class="keyword">public</span> Guid Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">SelectItems(nameof(Authors))</span>]</span><br><span class="line">            [<span class="meta">DisplayName(<span class="string">&quot;Author&quot;</span>)</span>]</span><br><span class="line">            <span class="keyword">public</span> Guid AuthorId &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">StringLength(128)</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            <span class="keyword">public</span> BookType Type &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = BookType.Undefined;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">            <span class="keyword">public</span> DateTime PublishDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125; = DateTime.Now;</span><br><span class="line"></span><br><span class="line">            [<span class="meta">Required</span>]</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">float</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将 <code>Book</code> 属性的类型从 <code>CreateUpdateBookDto</code> 修改为这个文件中新定义的 <code>EditBookViewModel</code> 类, 和我们前面所做的创建模型的修改一样.</li>
<li>移动新类 <code>EditBookViewModel</code> 的 <code>Id</code> 属性.</li>
<li>新增 <code>Authors</code> 属性, 在 <code>OnGetAsync</code> 方法中使用前面定义的 <code>IBookAppService.GetAuthorLookupAsync</code> 方法填充它.</li>
<li>修改 <code>OnPostAsync</code> 方法, 映射 <code>EditBookViewModel</code> 对象到 <code>CreateUpdateBookDto</code> 对象, 因为 <code>IBookAppService.UpdateAsync</code> 需要一个这种类型的参数.</li>
</ul>
<p>这些修改需要对 <code>EditModal.cshtml</code> 进行一些小修改. 移除 <code>&lt;abp-input asp-for=&quot;Id&quot; /&gt;</code> 标签, 因为我们不再需要它了 (因为它被移动到 <code>EditBookViewModel</code> 中了). <code>EditModal.cshtml</code> 的最终内容应为:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@page</span><br><span class="line">@using Acme.BookStore.Localization</span><br><span class="line">@using Acme.BookStore.Web.Pages.Books</span><br><span class="line">@using Microsoft.Extensions.Localization</span><br><span class="line">@using Volo.Abp.AspNetCore.Mvc.UI.Bootstrap.TagHelpers.Modal</span><br><span class="line">@model EditModalModel</span><br><span class="line">@inject IStringLocalizer<span class="tag">&lt;<span class="name">BookStoreResource</span>&gt;</span> L</span><br><span class="line">@&#123;</span><br><span class="line">    Layout = null;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">abp-dynamic-form</span> <span class="attr">abp-model</span>=<span class="string">&quot;Book&quot;</span> <span class="attr">asp-page</span>=<span class="string">&quot;/Books/EditModal&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">abp-modal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-header</span> <span class="attr">title</span>=<span class="string">&quot;@L[&quot;</span><span class="attr">Update</span>&quot;]<span class="attr">.Value</span>&quot;&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">abp-form-content</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">abp-modal-body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">abp-modal-footer</span> <span class="attr">buttons</span>=<span class="string">&quot;@(AbpModalButtons.Cancel|AbpModalButtons.Save)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">abp-modal-footer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">abp-modal</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">abp-dynamic-form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="对象到对象映射配置"><a href="#对象到对象映射配置" class="headerlink" title="对象到对象映射配置"></a>对象到对象映射配置</h4><p>以下修改需要定义一些对象到对象映射. 打开 <code>Acme.BookStore.Web</code> 项目中的 <code>BookStoreWebAutoMapperProfile.cs</code>, 在构造函数中添加下列映射定义:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CreateMap&lt;Pages.Books.CreateModalModel.CreateBookViewModel, CreateUpdateBookDto&gt;();</span><br><span class="line">CreateMap&lt;BookDto, Pages.Books.EditModalModel.EditBookViewModel&gt;();</span><br><span class="line">CreateMap&lt;Pages.Books.EditModalModel.EditBookViewModel, CreateUpdateBookDto&gt;();</span><br></pre></td></tr></table></figure>

<p>你可以运行应用程序, 尝试新建或更新一本书. 你将在新建&#x2F;更新表单上看到一个下拉框, 使用它指定图书的作者。</p>
<h2 id="Demo-Codes"><a href="#Demo-Codes" class="headerlink" title="Demo Codes"></a>Demo Codes</h2><blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3h5ZnkvQWJwLUxlYXJuLTIwMjIvY29tbWl0LzA4OGZmOWNjNjViZWNhYzUzZWMwOGFiZDI5YTI4NjI1YzVhOGJkMTI=">github commit<i class="fa fa-external-link-alt"></i></span><br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3h5ZnkvQWJwLUxlYXJuLTIwMjIvdHJlZS9hYnA3">total code<i class="fa fa-external-link-alt"></i></span></p>
</blockquote>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.png" alt="Xyfy 微信">
        <span>微信</span>
      </div>
      <div>
        <img src="/images/alipay.jpg" alt="Xyfy 支付宝">
        <span>支付宝</span>
      </div>

  </div>
</div>

          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Xyfy
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://www.52dzd.com/abplearn/seventh/" title="Abp vNext 学习(7)">https://www.52dzd.com/abplearn/seventh/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/Abp-vNext/" rel="tag"><i class="fa fa-tag"></i> Abp vNext</a>
              <a href="/tags/DDD/" rel="tag"><i class="fa fa-tag"></i> DDD</a>
              <a href="/tags/BookStore/" rel="tag"><i class="fa fa-tag"></i> BookStore</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/change-hexo-permalink-with301/" rel="prev" title="Hexo Change Permanent Link Format With Backward Compatibility">
                  <i class="fa fa-angle-left"></i> Hexo Change Permanent Link Format With Backward Compatibility
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/masa/framework/starter1/" rel="next" title="初识 MASA Framework">
                  初识 MASA Framework <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    
  <div class="comments" id="disqus_thread">
    <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
  </div>
  
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbg==">粤ICP备18091900号 </span>
  </div>
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Xyfy</span>
  </div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL3h5Znk=" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script size="300" alpha="0.6" zindex="-1" src="https://cdnjs.cloudflare.com/ajax/libs/ribbon.js/1.0.2/ribbon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/third-party/pace.js"></script>


  




<script class="next-config" data-name="disqus" type="application/json">{"enable":true,"shortname":"52dzd","count":true,"i18n":{"disqus":"disqus"}}</script>
<script src="/js/third-party/comments/disqus.js"></script>

</body>
</html>
